

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deploying dbt projects &mdash; omega-ml 0.16.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=bf4bd5a2" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=81998473"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            omega-ml
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devguide/index.html">Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nb/index.html">Tutorial Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../screenshots.html">Screenshots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../moreinfo.html">More information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes/index.html">Changes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">omega-ml</a>
      </nav>

      <div class="wy-nav-content">


        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Deploying dbt projects</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/guide/integration/dbt_one_by_one.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="deploying-dbt-projects">
<h1>Deploying dbt projects<a class="headerlink" href="#deploying-dbt-projects" title="Link to this heading">¶</a></h1>
<p>dbt projects can be deployed to run on the omega-ml runtime as an ad-hoc or a scheduled
job as follows. dbt projects are essentially a collection of files that make up a SQL-based
workflow. This means we can easily deploy dbt projects to omega-ml as a script, and run them
on schedule or on-demand.</p>
<ol class="arabic simple">
<li><p>Package the dbt project(s) and deploy to omega-ml</p></li>
<li><p>Schedule a job to run the dbt project(s)</p></li>
<li><p>Serve the dbt project(s) documentation via omegaml’s apphub (or browse locally)</p></li>
</ol>
<p>Here’s a quick schematic overview of the components involved:</p>
<section id="how-to-package-a-dbt-project">
<h2>How to package a dbt project<a class="headerlink" href="#how-to-package-a-dbt-project" title="Link to this heading">¶</a></h2>
<p>To deploy a dbt project, we first need to package the project into a pip-installable package.
This can be done by the following steps:</p>
<ol class="arabic simple">
<li><p>Mark the dbt project as a python package (by creating a <cite>__init__.py</cite> file)</p></li>
<li><p>Create the <cite>setup.py</cite> and <cite>MANIFEST.in</cite> files in the dbt directory</p></li>
<li><p>Store the dbt project in <cite>om.scripts</cite></p></li>
<li><p>Create a job (notebook) to run the dbt project on a schedule</p></li>
</ol>
<p>Let’s go through these steps in detail.</p>
<section id="create-a-dbt-project">
<h3>Create a dbt project<a class="headerlink" href="#create-a-dbt-project" title="Link to this heading">¶</a></h3>
<p>We assume a dbt project exists already. If not, you can create a new dbt project by following these
steps. To create a dbt project, we can use the dbt CLI. First, we need to install dbt:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>dbt-core
</pre></div>
</div>
<p>Then, we can create a new dbt project by running the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>dbt<span class="w"> </span>init<span class="w"> </span>myproject
</pre></div>
</div>
</section>
<section id="mark-your-dbt-project-as-a-python-package">
<h3>Mark your dbt project as a python package<a class="headerlink" href="#mark-your-dbt-project-as-a-python-package" title="Link to this heading">¶</a></h3>
<p>To deploy a dbt project to omega-ml, we need to package the project as a python package so it can
be installed in the runtime. This includes essentially two files:</p>
<ol class="arabic simple">
<li><p><cite>__init__.py</cite> to mark the dbt project as a python package</p></li>
<li><p>The dbt <cite>profiles.yml</cite> to specify the dbt profile (without any secrets)</p></li>
</ol>
<p>Mark the dbt project as a python package by creating a <cite>__init__.py</cite> file in the db project directory. We
will also include a <cite>profiles.yml</cite> that however does not include any secrets such as passwords or API keys.
Instead, we will update the dbt profile at runtime with omega-ml defaults.</p>
<p>In <cite>__init__.py</cite> we will add a function to update the dbt profile with omega-ml defaults. This function
is used at run-time to replace <cite>{PLACEHOLDER}</cite>-style variables, e.g. to specify an SQL connection details
such as server hostnames and passwords which are provided as part of the omega-ml qualifier context
in which the dbt project will run.</p>
<p>The <cite>__init__.py</cite> file should look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># /path/to/dbt/myproject/__init__.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_dbt_profile</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">om</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="nb">vars</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    update dbt profiles.yaml with omegaml defaults</span>

<span class="sd">    Usage:</span>
<span class="sd">        import omegaml as om</span>
<span class="sd">        mod = om.scripts.get(&#39;dbt/foo&#39;, install=True)</span>
<span class="sd">        update_dbt_profile(mod=mod, om=om)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
    <span class="n">default_fn</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s1">&#39;__file__&#39;</span><span class="p">,</span> <span class="vm">__file__</span><span class="p">))</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;profiles.yml&#39;</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">if</span> <span class="n">fn</span> <span class="k">else</span> <span class="n">default_fn</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dbt profiles.yml not found at </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">om</span><span class="o">.</span><span class="n">defaults</span><span class="p">)</span> <span class="k">if</span> <span class="n">om</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">profiles</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">parent</span>
</pre></div>
</div>
<p>Copy your profiles.yml from <cite>$HOME/.dbt/profiles.yml</cite>, and replace the values that are provided by
your omega-ml qualifier context with their respective <cite>{OMEGA_VARIABLE}</cite> placeholder.
Later we will use the <cite>update_dbt_profile</cite> function to replace these placeholders with the actual
values provided by omega-ml.</p>
<p>The <cite>profiles.yml</cite> file should look something like this (adopt to the specific variables used
in your omega-ml qualifier context):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">myproject</span><span class="p">:</span>
<span class="w">    </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod</span>
<span class="w">    </span><span class="nt">outputs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">prod</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sqlserver</span>
<span class="w">        </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{OMEGA_SQL_SERVER_DRIVER}&#39;</span><span class="w"> </span><span class="c1"># (The ODBC Driver installed on your system)</span>
<span class="w">        </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nv">OMEGA_SQL_SERVER_HOST</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1433</span>
<span class="w">        </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nv">OMEGA_SQL_SERVER_DB</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="nt">schema</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">schema_name</span>
<span class="w">        </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nv">OMEGA_SQL_SERVER_USER</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nv">OMEGA_SQL_SERVER_PASSWORD</span><span class="p p-Indicator">}</span>
</pre></div>
</div>
</section>
<section id="create-the-setup-py-and-manifest-in-files">
<h3>Create the setup.py and MANIFEST.in files<a class="headerlink" href="#create-the-setup-py-and-manifest-in-files" title="Link to this heading">¶</a></h3>
<p>The dbt project needs a <cite>setup.py</cite> file to be packaged as a python package. The <cite>setup.py</cite> file
should look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#  /path/to/dbt/setup.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">setuptools</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;myproject&#39;</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s1">&#39;0.1&#39;</span><span class="p">,</span>
    <span class="n">packages</span><span class="o">=</span><span class="n">find_packages</span><span class="p">(),</span>
    <span class="n">include_package_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">install_requires</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;dbt-core&#39;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>We also need a <cite>MANIFEST.in</cite> file to include the dbt project files (models, macros, etc.) in the package:</p>
<div class="highlight-script notranslate"><div class="highlight"><pre><span></span># myproject/MANIFEST.in
include *.in
recursive-include myproject *
</pre></div>
</div>
</section>
<section id="store-the-dbt-project-in-om-scripts">
<h3>Store the dbt project in <cite>om.scripts</cite><a class="headerlink" href="#store-the-dbt-project-in-om-scripts" title="Link to this heading">¶</a></h3>
<p>Then, we can package the dbt project by running the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># in /path/to/setup.py</span>
$<span class="w"> </span>om<span class="w"> </span>scripts<span class="w"> </span>put<span class="w"> </span>.<span class="w"> </span>myproject<span class="w"> </span>dbt/myproject
</pre></div>
</div>
</section>
</section>
<section id="schedule-a-job-notebook">
<h2>Schedule a job (notebook)<a class="headerlink" href="#schedule-a-job-notebook" title="Link to this heading">¶</a></h2>
<p>To run the dbt project on a schedule, we need to create a job (notebook) that runs the dbt project.
The notebook should look as follows and be stored in om.jobs. The notebook essentially has three
parts:</p>
<ol class="arabic simple">
<li><p>Import the dbt project and update the dbt profile with omega-ml defaults</p></li>
<li><p>Run the dbt project</p></li>
<li><p>Generate and save the dbt docs, so it is available for later inspection or
serving via omegaml’s apphub</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># cron: 0 0 * * 1</span>
    <span class="c1"># comment: run every Monday at midnight</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># (1) import dbt project and prepare dbt profile</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">omegaml</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">om</span>
    <span class="n">project</span> <span class="o">=</span> <span class="s1">&#39;dbt/foo&#39;</span>
    <span class="n">dbt_mod</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">install</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">project_dir</span> <span class="o">=</span> <span class="n">dbt_mod</span><span class="o">.</span><span class="n">update_dbt_profile</span><span class="p">(</span><span class="n">om</span><span class="o">=</span><span class="n">om</span><span class="p">,</span> <span class="n">OMEGA_BUCKET</span><span class="o">=</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># (2) run dbt project</span>
    <span class="err">!</span><span class="n">dbt</span> <span class="n">run</span> <span class="o">--</span><span class="n">profiles</span><span class="o">-</span><span class="nb">dir</span> <span class="err">$</span><span class="n">project_dir</span> <span class="o">--</span><span class="n">project</span><span class="o">-</span><span class="nb">dir</span> <span class="err">$</span><span class="n">project_dir</span>
<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># (3) generate docs and save to om.datasets as dbt/&lt;project&gt;/report.zip</span>
    <span class="c1"># generate docs</span>
    <span class="err">!</span><span class="n">dbt</span> <span class="n">docs</span> <span class="n">generate</span> <span class="o">--</span><span class="n">profiles</span><span class="o">-</span><span class="nb">dir</span> <span class="err">$</span><span class="n">project_dir</span> <span class="o">--</span><span class="n">project</span><span class="o">-</span><span class="nb">dir</span> <span class="err">$</span><span class="n">project_dir</span> <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">path</span> <span class="n">report</span>
    <span class="err">!</span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">zipfile</span> <span class="o">-</span><span class="n">c</span> <span class="n">report</span><span class="o">.</span><span class="n">zip</span> <span class="err">$</span><span class="n">project_dir</span><span class="o">/</span><span class="n">report</span>
    <span class="err">!</span><span class="n">om</span> <span class="n">datasets</span> <span class="n">put</span> <span class="o">./</span><span class="n">report</span><span class="o">.</span><span class="n">zip</span> <span class="err">$</span><span class="n">project</span><span class="o">/</span><span class="n">report</span><span class="o">.</span><span class="n">zip</span>
</pre></div>
</div>
</section>
<section id="browse-the-dbt-project-documentation">
<h2>Browse the dbt project documentation<a class="headerlink" href="#browse-the-dbt-project-documentation" title="Link to this heading">¶</a></h2>
<p>The dbt project documentation can be browsed locally by running the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># in /path/to/dbt/myproject</span>
$<span class="w"> </span>om<span class="w"> </span>datasets<span class="w"> </span>get<span class="w"> </span>dbt/myproject/report.zip<span class="w"> </span>-o<span class="w"> </span>report.zip
$<span class="w"> </span>unzip<span class="w"> </span>report.zip
$<span class="w"> </span>dbt<span class="w"> </span>docs<span class="w"> </span>serve<span class="w"> </span>--target-path<span class="w"> </span>report
</pre></div>
</div>
<p>Alternatively, the dbt project documentation can be served via omegaml’s apphub. To do this, we need to create a
a small flask app that serves the dbt project documentation, created and saved by the job (notebook) above.
The app should look as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># add this to path/to/dbt/myproject/__init__.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_app</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">abort</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Blueprint</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">zipfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">ZipFile</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">omegaml</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">om</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">server</span> <span class="ow">or</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">,</span>
                    <span class="n">url_prefix</span><span class="o">=</span><span class="n">uri</span><span class="p">,</span>
                    <span class="n">template_folder</span><span class="o">=</span><span class="s1">&#39;templates&#39;</span><span class="p">)</span>

    <span class="n">file_cache</span> <span class="o">=</span> <span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">om</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
        <span class="c1"># present a list of project reports stored in om.datasets</span>
        <span class="c1"># -- each project report is stored as dbt/&lt;project&gt;/report.zip</span>
        <span class="n">href</span> <span class="o">=</span> <span class="s2">&quot;&lt;a href=&#39;</span><span class="si">{uri}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/index&#39;&gt;</span><span class="si">{project}</span><span class="s2">&lt;/a&gt;&lt;br&gt;&quot;</span>
        <span class="n">projects</span> <span class="o">=</span> <span class="p">[</span><span class="n">href</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">project</span><span class="p">)),</span>
                                <span class="n">uri</span><span class="o">=</span><span class="n">uri</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">project</span> <span class="ow">in</span> <span class="n">om</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s1">&#39;dbt/*&#39;</span><span class="p">)]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&lt;p&gt;select a project to view its dbt report&lt;/p&gt;&quot;</span>
        <span class="k">return</span> <span class="n">text</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projects</span><span class="p">)</span> <span class="k">if</span> <span class="n">projects</span> <span class="k">else</span> <span class="s2">&quot;No projects found&quot;</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;project&gt;/index&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">project</span><span class="p">(</span><span class="n">project</span><span class="p">):</span>
        <span class="c1"># open the project report&#39;s index.html</span>
        <span class="n">_send_report_file</span><span class="o">.</span><span class="n">cache_clear</span><span class="p">()</span>
        <span class="n">project_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;dbt/</span><span class="si">{</span><span class="n">project</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">_send_report_file</span><span class="p">(</span><span class="n">project_dir</span><span class="p">,</span> <span class="s1">&#39;index.html&#39;</span><span class="p">)</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;project&gt;/&lt;path:path&gt;&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">static_file</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="c1"># open a static file from the project report</span>
        <span class="n">project_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;dbt/</span><span class="si">{</span><span class="n">project</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">_send_report_file</span><span class="p">(</span><span class="n">project_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_exception</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s2">&quot;exception&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
        <span class="p">},</span> <span class="mi">404</span>

    <span class="nd">@file_cache</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_send_report_file</span><span class="p">(</span><span class="n">project_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">report_fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s1">/report.zip&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">om</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">report_fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">zipfile</span> <span class="o">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;report/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">zipfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="n">server</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">server</span>
</pre></div>
</div>
<p>To run this app locally, we can use the following command:</p>
<blockquote>
<div><p>$ FLASK_APP=myproject:create_app flask run</p>
</div></blockquote>
<p>To serve the app via omegaml’s apphub, we need to package the app as a python package
and store it in om.scripts.</p>
<blockquote>
<div><p>$ om scripts put . myproject apps/myproject
$ om runtime restart app myproject</p>
</div></blockquote>
</section>
</section>
<section id="working-with-multiple-dbt-projects">
<h1>Working with multiple dbt projects<a class="headerlink" href="#working-with-multiple-dbt-projects" title="Link to this heading">¶</a></h1>
<p>If you have multiple dbt projects, you can either follow the same steps as above, applied
to each project, or you can create a single “dbtdeploy” application, that can be used
to run multiple dbt projects.</p>
<p>Here’s how to create the “dbtdeploy” application:</p>
<ol class="arabic">
<li><p>Create a dbtdeploy application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># in /path/to/dbt
$ mkdir dbtdeploy
$ touch dbtdeploy/__init__.py
$ touch dbtdeploy/setup.py
$ touch dbtdeploy/MANIFEST.in
</pre></div>
</div>
</li>
<li><p>Update the <cite>setup.py</cite> and <cite>MANIFEST.in</cite> files:</p>
<blockquote>
<div><p># dbtdeploy/setup.py
from setuptools import setup, find_packages</p>
<dl>
<dt>setup(</dt><dd><p>name=’dbtdeploy’,
version=’0.1’,
packages=find_packages(),
include_package_data=True,
install_requires=[</p>
<blockquote>
<div><p>‘dbt-core’,</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>)</p>
<p># dbtdeploy/MANIFEST.in
include <a href="#id1"><span class="problematic" id="id2">*</span></a>.in
recursive-include dbtdeploy *
recursive-include myproject *
&lt;.. include other dbt projects here ..&gt;</p>
</div></blockquote>
</li>
<li><p>Update the __init__.py file for the dbtdeploy application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># include the update_dbt_profile function, from above</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_dbt_profile</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">om</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="nb">vars</span><span class="p">):</span>
    <span class="o">&lt;...</span> <span class="n">copy</span> <span class="kn">from</span><span class="w"> </span><span class="nn">above</span> <span class="n">verbabtim</span> <span class="o">...&gt;</span>

<span class="c1"># include the create_app function, from above</span>
    <span class="o">&lt;...</span> <span class="n">copy</span> <span class="kn">from</span><span class="w"> </span><span class="nn">above</span> <span class="n">verbabtim</span> <span class="o">...&gt;</span>
</pre></div>
</div>
</li>
</ol>
<p>Now we can package the dbtdeploy application, including all dbt projects
into a single dbtdeploy application.</p>
<ol class="arabic">
<li><p>Link each dbt project into the directory of the dbtdeploy application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ln -s /path/to/dbt/myproject dbtdeploy/myproject
</pre></div>
</div>
</li>
<li><p>Package the dbtdeploy application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ om scripts put . dbtdeploy dbt/dbtdeploy
</pre></div>
</div>
</li>
</ol>
<p>Finally, we can use the dbtdeploy application to run multiple dbt projects.</p>
<ol class="arabic">
<li><p>Create a job (notebook) to run the dbtdeploy application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># in om.jobs
[1] # cron: 0 0 * * 1
    # comment: run every Monday at midnight
[2] # (1) import dbt project and prepare dbt profile
    dbtdeploy = om.scripts.get(&#39;dbt/dbtdeploy&#39;, install=True)
    dbt_dir = Path(dbtdeploy.__file__).parent
    dbtdeploy.update_dbt_profile(f&quot;{dbt_dir}/profiles.yml&quot;, om=om)
[3] # (2) run dbt projects (repeat (2) and (3) for each dbt project)
    project_dir =  dbt_dir / &#39;foo`
    !dbt run --profiles-dir $dbt_dir --project-dir $project_dir
[4] # (3) generate docs and save to om.datasets as dbt/&lt;project&gt;/report.zip
    # generate docs
    !dbt docs generate --profiles-dir $dbt_dir --project-dir $project_dir --target-path report
    !python -m zipfile -c report.zip $project_dir/report
    !om datasets put ./report.zip $project/report.zip
</pre></div>
</div>
</li>
<li><p>Serve the dbt project documentation via omegaml’s apphub:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># package the app
$ om scripts put . dbtdeploy apps/dbtdeploy
$ om runtime restart app dbtdeploy

Alterantively, you can serve the app locally by running the following command:

$ FLASK_APP=dbtdeploy:create_app flask run
</pre></div>
</div>
</li>
</ol>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022 (c) omegaml.io by one2seven GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>

      </div>
    </section>
  </div>
  <!-- version plugin for rtd template without sidebar -->
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: stable
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../../0.11.3/index.html" class="version-ref-0.11.3">0.11.3</a></dd>
      <dd><a href="../../../0.11.4/index.html" class="version-ref-0.11.4">0.11.4</a></dd>
      <dd><a href="../../../0.12.0/index.html" class="version-ref-0.12.0">0.12.0</a></dd>
      <dd><a href="../../../0.13.0/index.html" class="version-ref-0.13.0">0.13.0</a></dd>
      <dd><a href="../../../0.13.2/index.html" class="version-ref-0.13.2">0.13.2</a></dd>
      <dd><a href="../../../0.13.4/index.html" class="version-ref-0.13.4">0.13.4</a></dd>
      <dd><a href="../../../0.13.5/index.html" class="version-ref-0.13.5">0.13.5</a></dd>
      <dd><a href="../../../0.13.6/index.html" class="version-ref-0.13.6">0.13.6</a></dd>
      <dd><a href="../../../0.13.7/index.html" class="version-ref-0.13.7">0.13.7</a></dd>
      <dd><a href="../../../0.14.0/index.html" class="version-ref-0.14.0">0.14.0</a></dd>
      <dd><a href="../../../0.15.1/index.html" class="version-ref-0.15.1">0.15.1</a></dd>
      <dd><a href="../../../0.15.2/index.html" class="version-ref-0.15.2">0.15.2</a></dd>
      <dd><a href="../../../latest/guide/integration/dbt_one_by_one.html" class="version-ref-latest">latest</a></dd>
      <dd><a href="../../../release/0.15.3/index.html" class="version-ref-release/0.15.3">0.15.3</a></dd>
      <dd><a href="../../../release/0.15.5/index.html" class="version-ref-release/0.15.5">0.15.5</a></dd>
      <dd><a href="../../../release/0.16.0/index.html" class="version-ref-release/0.16.0">0.16.0</a></dd>
      <dd><a href="../../../release/0.16.1/index.html" class="version-ref-release/0.16.1">0.16.1</a></dd>
      <dd><a href="../../../release/0.16.2/index.html" class="version-ref-release/0.16.2">0.16.2</a></dd>
      <dd><a href="../../../release/0.16.3/index.html" class="version-ref-release/0.16.3">0.16.3</a></dd>
      <dd><a href="../../../release/0.16.4/guide/integration/dbt_one_by_one.html" class="version-ref-release/0.16.4">0.16.4</a></dd>
      <dd><a href="../../../release/0.4/index.html" class="version-ref-release/0.4">0.4</a></dd>
      <dd><a href="../../../release/0.5/index.html" class="version-ref-release/0.5">0.5</a></dd>
      <dd><a href="../../../release/0.9/index.html" class="version-ref-release/0.9">0.9</a></dd>
      <dd><a href="dbt_one_by_one.html" class="version-ref-stable">stable</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../../master/guide/integration/dbt_one_by_one.html">master</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>