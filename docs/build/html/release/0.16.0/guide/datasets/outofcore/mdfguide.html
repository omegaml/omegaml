<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Working with MDataFrame &mdash; omega-ml 1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=bf4bd5a2" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=56dcb7b8"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="MDataFrame Operations" href="mdataframe.html" />
    <link rel="prev" title="Large, Out of Core-sized DataFrames" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            omega-ml
          </a>
              <div class="version">
                1.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/index.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../intro/index.html">Getting started</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Working with datasets</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../store_retrieve.html">Storing and retrieving data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../filterdf.html">Filtering Data</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Large, Out of Core-sized DataFrames</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">Working with MDataFrame</a></li>
<li class="toctree-l4"><a class="reference internal" href="mdataframe.html">MDataFrame Operations</a></li>
<li class="toctree-l4"><a class="reference internal" href="mdfapply.html">Aggregation Framework</a></li>
<li class="toctree-l4"><a class="reference internal" href="mdfdebug.html">Debugging</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../models/index.html">Working with models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs/index.html">Working with notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../clusters/index.html">Deploying models and pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cli/index.html">Command-line interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/index.html">Advanced features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../integration/index.html">Integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../admin/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devguide/index.html">Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nb/index.html">Tutorial Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../screenshots.html">Screenshots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../moreinfo.html">More information</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">omega-ml</a>
      </nav>

      <div class="wy-nav-content">

<div class="version-warning-banner">
    
    You're reading an old version of this documentation.
    If you want up-to-date information, please have a look at <a href="../../../../0.16.3/guide/datasets/outofcore/mdfguide.html">release/0.16.3</a>.
    
</div>


        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">User Guide</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Working with datasets</a></li>
          <li class="breadcrumb-item"><a href="index.html">Large, Out of Core-sized DataFrames</a></li>
      <li class="breadcrumb-item active">Working with MDataFrame</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/guide/datasets/outofcore/mdfguide.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="working-with-mdataframe">
<h1><a class="toc-backref" href="#id1" role="doc-backlink">Working with MDataFrame</a><a class="headerlink" href="#working-with-mdataframe" title="Link to this heading">¶</a></h1>
<p>A short guide</p>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#working-with-mdataframe" id="id1">Working with MDataFrame</a></p>
<ul>
<li><p><a class="reference internal" href="#what-is-mdataframe" id="id2">What is MDataFrame?</a></p></li>
<li><p><a class="reference internal" href="#concepts" id="id3">Concepts</a></p></li>
<li><p><a class="reference internal" href="#storing-data-as-an-mdataframe" id="id4">Storing data as an MDataFrame</a></p></li>
<li><p><a class="reference internal" href="#getting-an-mdataframe" id="id5">Getting an MDataFrame</a></p></li>
<li><p><a class="reference internal" href="#executing-a-query" id="id6">Executing a query</a></p></li>
<li><p><a class="reference internal" href="#persisting-the-result-of-a-query" id="id7">Persisting the result of a query</a></p></li>
<li><p><a class="reference internal" href="#slicing" id="id8">Slicing</a></p></li>
<li><p><a class="reference internal" href="#filtering" id="id9">Filtering</a></p></li>
<li><p><a class="reference internal" href="#aggregation-and-transformation" id="id10">Aggregation and transformation</a></p></li>
<li><p><a class="reference internal" href="#in-database-transformations" id="id11">In-database transformations</a></p></li>
<li><p><a class="reference internal" href="#parallel-transformations" id="id12">Parallel transformations</a></p></li>
<li><p><a class="reference internal" href="#customized-chunking" id="id13">Customized chunking</a></p></li>
<li><p><a class="reference internal" href="#lazy-evaluation" id="id14">Lazy evaluation</a></p></li>
<li><p><a class="reference internal" href="#what-wont-work" id="id15">What won’t work</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="what-is-mdataframe">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">What is MDataFrame?</a><a class="headerlink" href="#what-is-mdataframe" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MDataFrame</span></code> provides a Pandas-like API to omega-ml’s analytics
storage (backed by MongoDB). The key thing about <code class="docutils literal notranslate"><span class="pre">MDataFrames</span></code> is
that they represent the <em>description of data and processes applied to
the data</em>, but do not contain data itself. In this sense
<code class="docutils literal notranslate"><span class="pre">MDataFrame</span></code> is the same for MongoDB as SQL is for a relational
database: a query language.</p></li>
<li><p>Like Pandas <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>, <code class="docutils literal notranslate"><span class="pre">MDataFrame</span></code> provides convenient
operations for querying, subsetting, and grouping data. The key
difference is that while Pandas must always load all data into memory
before operating on it, <code class="docutils literal notranslate"><span class="pre">MDataFrame</span></code> passes operations on to the
database. The result of such operations is typically a Pandas
<code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>, or another <code class="docutils literal notranslate"><span class="pre">MDataFrame</span></code>.</p></li>
<li><p>For cases where the we need more complex processing than the database
supports, <code class="docutils literal notranslate"><span class="pre">MDataFrame</span></code> can run a Python function on the data in
parallel.</p></li>
<li><p>Note that <code class="docutils literal notranslate"><span class="pre">MDataFrame</span></code> <em>is not</em> a drop-in replacement for Pandas
<code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>.</p></li>
</ul>
</section>
<section id="concepts">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Concepts</a><a class="headerlink" href="#concepts" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MDataFrame</span></code>: reprents a columnar datastructure made of of columns
and rows</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MSeries</span></code>: represents all values in a single column</p></li>
</ul>
<p>In addition there are several helpers that provide specific
functionality, e.g. for positional access, slicing and group-by
processing. We don’t specify the details of these helpers as they are
tied into the MDataFrame and MSeries API.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.value</span></code> resolves the result of all operations, e.g. filtering,
slicing, aggregation to a local in-memory pandas dataframe (useful
for exploratory tasks and groupby aggregation)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.apply()</span></code> provides in-database processing (e.g. filtering,
slicing, aggregation)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.transform()</span></code> provides parallel out-of-core, chunk-by-chunk
processing (use for large datasets)</p></li>
</ul>
</section>
<section id="storing-data-as-an-mdataframe">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Storing data as an MDataFrame</a><a class="headerlink" href="#storing-data-as-an-mdataframe" title="Link to this heading">¶</a></h2>
<p>You can store any of the following objects and return them as an
MDataFrame:</p>
<ul class="simple">
<li><p>Pandas Dataframe (and any source that Pandas supports):
<code class="docutils literal notranslate"><span class="pre">om.datasets.put(df,</span> <span class="pre">'name')</span></code></p></li>
<li><p>Any sql source supported by the (e.g. snowflake)
<code class="docutils literal notranslate"><span class="pre">om.datasets.put('connstr',</span> <span class="pre">'name')</span></code></p></li>
<li><p>CSV files from an externally hosted source (ftp, http, s3):
<code class="docutils literal notranslate"><span class="pre">om.datasets.put(None,</span> <span class="pre">'name',uri='http://....')</span></code></p></li>
<li><p>Any other tabular-like data that you insert into the analytics store
(i.e. MongoDB): <code class="docutils literal notranslate"><span class="pre">om.datasets.put(docs,</span> <span class="pre">'name')</span></code></p></li>
</ul>
<p>Note in general the MDataFrame is not dependent on the original <em>source</em>
of the data, but on the format it is stored in omega-ml’s analytics
storage. As long as the data can be retrieved back and transformed to a
format Pandas can work with, MDataFrame will be able to handle it. That
said, it works easiest with tabular data of rows and columns where each
cell has some scalar value.</p>
</section>
<section id="getting-an-mdataframe">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Getting an MDataFrame</a><a class="headerlink" href="#getting-an-mdataframe" title="Link to this heading">¶</a></h2>
<p>The following methods are equivalent, both return an instance of
<code class="docutils literal notranslate"><span class="pre">MDataFrame</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mdf</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">getl</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
<span class="n">mdf</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Using any of these methods, <code class="docutils literal notranslate"><span class="pre">mdf</span></code> will represent the <code class="docutils literal notranslate"><span class="pre">MDataFrame</span></code>
instance. Note that this will return immediately as no data access
happens at this time.</p>
</section>
<section id="executing-a-query">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Executing a query</a><a class="headerlink" href="#executing-a-query" title="Link to this heading">¶</a></h2>
<p>To actually get data from a MDataFrame you need to ask for evaluation.
This will execute the query according to all operations applied so far.
The result is a standard Pandas DataFrame:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mdf</span><span class="o">.</span><span class="n">value</span>
</pre></div>
</div>
<p><strong>Note this can be a dangerous operation as it will load all the data
into memory</strong> If the result of your query is larger than the available
memory of your process, it will fail and result in an operating-system
level out of memory condition. If you are unsure how many rows a query
will return, try using <code class="docutils literal notranslate"><span class="pre">.count()</span></code> first.</p>
</section>
<section id="persisting-the-result-of-a-query">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Persisting the result of a query</a><a class="headerlink" href="#persisting-the-result-of-a-query" title="Link to this heading">¶</a></h2>
<p>To evaluate an MDataFrame without returning all data into memory, use
the <code class="docutils literal notranslate"><span class="pre">.persist()</span></code> method</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mdf</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">om</span><span class="o">.</span><span class="n">datasets</span><span class="p">)</span>
</pre></div>
</div>
<p>This is the equivalent of
<code class="docutils literal notranslate"><span class="pre">df</span> <span class="pre">=</span> <span class="pre">mdf.value;</span> <span class="pre">om.datasets.put(df,</span> <span class="pre">'name')</span></code>, however all operations
are performed in the database, results are retrieved back to memory only
if needed, and if so in small chunks.</p>
</section>
<section id="slicing">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Slicing</a><a class="headerlink" href="#slicing" title="Link to this heading">¶</a></h2>
<p>Like Pandas DataFrame, MDataFrame can be sliced</p>
<ul class="simple">
<li><p>by a set of columns: <code class="docutils literal notranslate"><span class="pre">mdf[['col1',</span> <span class="pre">'col2']]</span></code> =&gt; return a MDataFrame
subset to col1, col2</p></li>
<li><p>by single columns <code class="docutils literal notranslate"><span class="pre">mdf['col1']</span></code> =&gt; return a MSeries</p></li>
<li><p>by rows <code class="docutils literal notranslate"><span class="pre">mdf.iloc[start:end]</span></code> =&gt; return a MDataFrame subset to rows
with index start to end.</p></li>
<li><p>by index <code class="docutils literal notranslate"><span class="pre">mdf.loc[label]</span></code> =&gt; return a MDataFrame subset to columns
with corresponding labels</p></li>
<li><p>by filter <code class="docutils literal notranslate"><span class="pre">mdf[filter-mask]</span></code>=&gt; return a MDataFrame subset to the
filter mask</p></li>
</ul>
<p>Note that <code class="docutils literal notranslate"><span class="pre">.loc,</span> <span class="pre">.iloc</span></code> require the data to have been stored from a
Pandas DataFrame.</p>
</section>
<section id="filtering">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Filtering</a><a class="headerlink" href="#filtering" title="Link to this heading">¶</a></h2>
<p><em>By filter masks</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flt</span> <span class="o">=</span> <span class="n">mdf</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span>  <span class="c1"># use any operator supported by MSeries</span>
<span class="n">mdf</span><span class="p">[</span><span class="n">flt</span><span class="p">]</span>
</pre></div>
</div>
<p>Filtering can be done by using a combination of
<code class="docutils literal notranslate"><span class="pre">keyword__&lt;operator&gt;=&lt;value</span></code></p>
</section>
<section id="aggregation-and-transformation">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Aggregation and transformation</a><a class="headerlink" href="#aggregation-and-transformation" title="Link to this heading">¶</a></h2>
<p>MDataFrame provides a powerful set of aggregations:</p>
<ul class="simple">
<li><p>in-database or local groupby processing <code class="docutils literal notranslate"><span class="pre">mdf.groupby</span></code></p></li>
<li><p>in-database transformation and aggregation <code class="docutils literal notranslate"><span class="pre">mdf.apply()</span></code></p></li>
<li><p>out-of-core parallel processing <code class="docutils literal notranslate"><span class="pre">mdf.transform()</span></code></p></li>
</ul>
</section>
<section id="in-database-transformations">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">In-database transformations</a><a class="headerlink" href="#in-database-transformations" title="Link to this heading">¶</a></h2>
<p>Using <code class="docutils literal notranslate"><span class="pre">MDataFrame.apply()</span></code> we can apply several column-wise
transformations. Note that the function passed to apply must accept an
ApplyContext.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1000</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="p">{</span>
    <span class="s1">&#39;key&#39;</span>      <span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;l_orderkey&#39;</span><span class="p">],</span>
    <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;l_comment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="s1">&#39; *&#39;</span><span class="p">),</span>
    <span class="s1">&#39;docs&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;l_shipinstruct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">usplit</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span>
    <span class="s1">&#39;comment_lower&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;l_shipinstruct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
    <span class="s1">&#39;comment_substr&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;l_shipinstruct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;week&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;l_shipdate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">week</span><span class="p">,</span>
    <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;l_shipdate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
<span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
</pre></div>
</div>
<p>Note: Unlike a Pandas apply which executes the function for every row or
column, MDataFrame will <strong>execute the function only once</strong> in order to
build the database query. If you want to execute Python code row-by-row,
or group-by-group, use <code class="docutils literal notranslate"><span class="pre">.tranform()</span></code>, see below.</p>
</section>
<section id="parallel-transformations">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Parallel transformations</a><a class="headerlink" href="#parallel-transformations" title="Link to this heading">¶</a></h2>
<p>MDataFrame supports in-parallel processing of arbitrary subsets and size
of data. By default, the subset will be by row number, but any other
grouping is possible.</p>
<p>The following snipped will start N / chunksize tasks and process them in
parallel. Each task processes N / chunksize records. The default
chunksize is 50’000. The number of parallel jobs started by default is
CPU count - 1.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">myproc</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="n">mdf</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">myproc</span><span class="p">)</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">om</span><span class="o">.</span><span class="n">datasets</span><span class="p">)</span>
</pre></div>
</div>
<p>More explanations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">myproc</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="c1"># df is the subset of the ith chunk of the full data</span>
    <span class="c1"># it is a Pandas in-memory DataFrame, apply any Pandas function you like</span>
    <span class="c1"># assignment is supported</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="c1"># groupby is also possible</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">...</span>
    <span class="c1"># either return None (or no return statement) =&gt; updated df is written to the db</span>
    <span class="c1"># or return a DataFrame or a Series =&gt; returned object is written to the db</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># this will start N = len(mdf) / 50&#39;000 tasks and store the results in om.datasets</span>
<span class="c1"># conceptually this is the equivalence of df = mdf.value.apply(myproc); om.datasets.put(df)</span>
<span class="c1"># however using mdf.transform() will use much less memory and easily scale out of core</span>
<span class="n">mdf</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">myproc</span><span class="p">)</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">om</span><span class="o">.</span><span class="n">datasets</span><span class="p">)</span>

<span class="c1"># specify chunksize and n_jobs to influence the number of chunks and the number of parallel workers.</span>
<span class="c1"># note this comes at a trade-off: many workers will take longer to complete, larger chunksizes will use more memory</span>
<span class="n">mdf</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">myproc</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=&lt;</span><span class="c1">#records&gt;, n_jobs=#numbers).persist(&#39;name&#39;, store=om.datasets)</span>
</pre></div>
</div>
</section>
<section id="customized-chunking">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">Customized chunking</a><a class="headerlink" href="#customized-chunking" title="Link to this heading">¶</a></h2>
<p>By default <code class="docutils literal notranslate"><span class="pre">.transform()</span></code> uses the size of the data (as in number of
rows) do determine the number of chunks. You can however create any
number chunks:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mdf</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">getl</span><span class="p">(</span><span class="s1">&#39;retail&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">ldf</span><span class="p">):</span>
    <span class="n">ldf</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ldf</span><span class="p">[</span><span class="s1">&#39;l_comment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chunker</span><span class="p">(</span><span class="n">mdf</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">maxobs</span><span class="p">):</span>
    <span class="c1"># for each chunk yield a MDataFrame subset for each chunk</span>
    <span class="c1"># note: don&#39;t use .value before yielding as this would resolve the dataframe locally</span>
    <span class="c1">#       and potentially consume all memory.</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">mdf</span><span class="p">[</span><span class="s1">&#39;l_returnflag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxobs</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">mdf</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">chunksize</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">l_returnflag</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>

<span class="p">(</span><span class="n">mdf</span>
 <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">chunkfn</span><span class="o">=</span><span class="n">chunker</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
 <span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="s1">&#39;retail-transformed&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">om</span><span class="o">.</span><span class="n">datasets</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="lazy-evaluation">
<h2><a class="toc-backref" href="#id14" role="doc-backlink">Lazy evaluation</a><a class="headerlink" href="#lazy-evaluation" title="Link to this heading">¶</a></h2>
<p>Using lazy evaluation we can get back a proxy DataFrame, an <code class="code docutils literal notranslate"><span class="pre">MDataFrame</span></code>,
which provides many of the features of a Pandas DataFrame including <code class="code docutils literal notranslate"><span class="pre">.loc</span></code>
indexing and slicing, column projection and aggregation. All of these
operations, however, are executed by the database and thus support out-of-core
sized DataFrames, that is DataFrames of arbitrary size.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ask for a reference to the dfx dataset with lazy evaluation</span>
<span class="n">om</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dfx&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">=&gt;</span>
<span class="o">&lt;</span><span class="n">omegaml</span><span class="o">.</span><span class="n">mdataframe</span><span class="o">.</span><span class="n">MDataFrame</span> <span class="n">at</span> <span class="mh">0x7fa3e991ee48</span><span class="o">&gt;</span>

<span class="c1"># same thing, getl is convenience method that automatically specifies lazy=True</span>
<span class="n">om</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">getl</span><span class="p">(</span><span class="s1">&#39;dfx&#39;</span><span class="p">)</span>
<span class="o">=&gt;</span>
<span class="o">&lt;</span><span class="n">omegaml</span><span class="o">.</span><span class="n">mdataframe</span><span class="o">.</span><span class="n">MDataFrame</span> <span class="n">at</span> <span class="mh">0x7fa3e991ee48</span><span class="o">&gt;</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">MDataFrame</span></code> in many ways behaves like a normal dataframe, however the
evaluation of operations is _lazy_ and is executed by the database as opposed
to in-memory. This allows us to process data that is larger than memory.</p>
<p>In order to evaluate <code class="code docutils literal notranslate"><span class="pre">MDataFrame</span></code> and return an actual
<code class="code docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code> just access the <code class="code docutils literal notranslate"><span class="pre">.value</span></code> property:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">om</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dfx&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
<span class="o">=&gt;</span>
    <span class="n">x</span>  <span class="n">y</span>
 <span class="mi">0</span>  <span class="mi">0</span>  <span class="mi">0</span>
 <span class="mi">1</span>  <span class="mi">1</span>  <span class="mi">1</span>
 <span class="mi">2</span>  <span class="mi">2</span>  <span class="mi">2</span>
 <span class="mi">3</span>  <span class="mi">3</span>  <span class="mi">3</span>
 <span class="mi">4</span>  <span class="mi">4</span>  <span class="mi">4</span>
</pre></div>
</div>
</section>
<section id="what-wont-work">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">What won’t work</a><a class="headerlink" href="#what-wont-work" title="Link to this heading">¶</a></h2>
<p><em>MDataFrame are currently read-only. In other words, assignment, column
additions and smilar operations are not currently supported. This is not
an inherent restriction, there is just no API for it in the current
implementation. Note if updates are required, the MDataFrame plugin
mechanism provides a straight-forward way to provide such
functionality.</em></p>
<p>Hence the following kind of operations are <strong>not currently supported</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="n">mdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="n">mdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="c1"># partial support is available, but limited to scalar values</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Large, Out of Core-sized DataFrames" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="mdataframe.html" class="btn btn-neutral float-right" title="MDataFrame Operations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022 (c) omegaml.io by one2seven GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>

      </div>
    </section>
  </div>
  <!-- version plugin for rtd template without sidebar -->
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: release/0.16.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../../../../0.11.3/index.html" class="version-ref-0.11.3">0.11.3</a></dd>
      <dd><a href="../../../../../0.11.4/index.html" class="version-ref-0.11.4">0.11.4</a></dd>
      <dd><a href="../../../../../0.12.0/index.html" class="version-ref-0.12.0">0.12.0</a></dd>
      <dd><a href="../../../../../0.13.0/index.html" class="version-ref-0.13.0">0.13.0</a></dd>
      <dd><a href="../../../../../0.13.2/index.html" class="version-ref-0.13.2">0.13.2</a></dd>
      <dd><a href="../../../../../0.13.4/index.html" class="version-ref-0.13.4">0.13.4</a></dd>
      <dd><a href="../../../../../0.13.5/index.html" class="version-ref-0.13.5">0.13.5</a></dd>
      <dd><a href="../../../../../0.13.6/index.html" class="version-ref-0.13.6">0.13.6</a></dd>
      <dd><a href="../../../../../0.13.7/index.html" class="version-ref-0.13.7">0.13.7</a></dd>
      <dd><a href="../../../../../0.14.0/index.html" class="version-ref-0.14.0">0.14.0</a></dd>
      <dd><a href="../../../../../0.15.1/index.html" class="version-ref-0.15.1">0.15.1</a></dd>
      <dd><a href="../../../../../0.15.2/guide/datasets/outofcore/mdfguide.html" class="version-ref-0.15.2">0.15.2</a></dd>
      <dd><a href="../../../../../latest/guide/datasets/outofcore/mdfguide.html" class="version-ref-latest">latest</a></dd>
      <dd><a href="../../../../0.15.3/guide/datasets/outofcore/mdfguide.html" class="version-ref-release/0.15.3">0.15.3</a></dd>
      <dd><a href="../../../../0.15.5/guide/datasets/outofcore/mdfguide.html" class="version-ref-release/0.15.5">0.15.5</a></dd>
      <dd><a href="mdfguide.html" class="version-ref-release/0.16.0">0.16.0</a></dd>
      <dd><a href="../../../../0.16.1/guide/datasets/outofcore/mdfguide.html" class="version-ref-release/0.16.1">0.16.1</a></dd>
      <dd><a href="../../../../0.16.2/guide/datasets/outofcore/mdfguide.html" class="version-ref-release/0.16.2">0.16.2</a></dd>
      <dd><a href="../../../../0.16.3/guide/datasets/outofcore/mdfguide.html" class="version-ref-release/0.16.3">0.16.3</a></dd>
      <dd><a href="../../../../0.4/index.html" class="version-ref-release/0.4">0.4</a></dd>
      <dd><a href="../../../../0.5/index.html" class="version-ref-release/0.5">0.5</a></dd>
      <dd><a href="../../../../0.9/index.html" class="version-ref-release/0.9">0.9</a></dd>
      <dd><a href="../../../../../stable/guide/datasets/outofcore/mdfguide.html" class="version-ref-stable">stable</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../../../../master/index.html">master</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>