

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini-Batch Streaming &mdash; omega-ml 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=bf4bd5a2" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Administration" href="../admin/index.html" />
    <link rel="prev" title="Runtime Clusters" href="runtimes.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            omega-ml
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">omega|ml - DataOps &amp; MLOps for humans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html#get-started-in-5-minutes">Get started in &lt; 5 minutes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html#examples">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html#use-cases">Use Cases</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="getstarted.html">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="store_retrieve.html">Storing and retrieving data</a></li>
<li class="toctree-l2"><a class="reference internal" href="filterdf.html">Filtering Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="mdfapply.html">Aggregation Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="modelstore.html">Working with Machine Learning Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="lambda.html">Lambda Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="restapi.html">REST API</a></li>
<li class="toctree-l2"><a class="reference internal" href="custombackends.html">Implementing a Custom Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="runtimes.html">Runtime Clusters</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Mini-Batch Streaming</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-stream">Creating a stream</a></li>
<li class="toctree-l3"><a class="reference internal" href="#implementing-a-producer">Implementing a Producer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#implementing-a-consumer">Implementing a Consumer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#implementing-a-custom-windowemitter">Implementing a custom WindowEmitter</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../admin/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devguide/index.html">Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nb/index.html">Tutorial Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../screenshots.html">Screenshots</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">omega-ml</a>
      </nav>

      <div class="wy-nav-content">

<div class="version-warning-banner">
    
    You're reading the documentation for a development version.
    For the latest released version, please have a look at <a href="../../release/0.16.4/index.html">release/0.16.4</a>.
    
</div>


        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">User Guide</a></li>
      <li class="breadcrumb-item active">Mini-Batch Streaming</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/guide/streaming.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mini-batch-streaming">
<h1>Mini-Batch Streaming<a class="headerlink" href="#mini-batch-streaming" title="Link to this heading">¶</a></h1>
<p><em>Enterprise Edition</em></p>
<p>omega|ml provides a straight-forward, Python-native approach to mini-batch streaming and complex-event
processing that is highly scalable. Streaming primarily consists of</p>
<ul class="simple">
<li><p>a producer, which is some function inserting data into the stream</p></li>
<li><p>a consumer, which is some function retrieving data from the stream</p></li>
</ul>
<p>Instead of directly connection producers and consumers, a producer sends messages to a stream. Think
of a stream as an endless buffer, or a pipeline, that takes input from many producers on one end, and
outputs messages to a consumer on the other end. This transfer of messages happens asynchronously, that
is the producer can send messages to the stream independent of whether the consumer is ready to receive, and the
consumer can take messages from the stream independent of whether the producer is ready to send.</p>
<p>Unlike usual asynchronous messaging, however, we want the consumer to receive messages in small batches as
to optimize throughput. That is, we want the pipeline to <em>emit</em> messages only subject to some criteria
of grouping messages, where each group is called a <em>mini-batch</em>. The function that determines whether the
batching criteria is met (e.g. time elapsed, number of messages in the pipeline) is called <em>emitter strategy</em>,
and the output it produces is called <em>window</em>.</p>
<p>Thus in order to connect producers and consumers we need a few more parts to our streaming system:</p>
<ul class="simple">
<li><p>a <code class="code docutils literal notranslate"><span class="pre">Stream</span></code>, acting as the buffer where messages sent by producers are stored until the emitting</p></li>
<li><p>a <code class="code docutils literal notranslate"><span class="pre">WindowEmitter</span></code> implementing the emitter strategy</p></li>
<li><p>a <code class="code docutils literal notranslate"><span class="pre">Window</span></code> representing the output produced by the emitter strategy</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The producer accepts input from some external system, say a Kafka queue. The producer’s responsibility
is to enter the data into the streaming buffer. The consumer uses some emitter strategy to produce
a Window of data that is then forwarded to the user’s processing code.</p>
</div>
<section id="creating-a-stream">
<h2>Creating a stream<a class="headerlink" href="#creating-a-stream" title="Link to this heading">¶</a></h2>
<p>Streams can be created by either consumers or producers. A stream can be connected to by both.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="implementing-a-producer">
<h2>Implementing a Producer<a class="headerlink" href="#implementing-a-producer" title="Link to this heading">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># a very simple producer</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">stream</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()})</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">.5</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="implementing-a-consumer">
<h2>Implementing a Consumer<a class="headerlink" href="#implementing-a-consumer" title="Link to this heading">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># a fixed size consumer -- emits windows of fixed sizes</span>
<span class="nd">@stream</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">myprocess</span><span class="p">(</span><span class="n">window</span><span class="p">):</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">processed</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">window</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="p">{}})</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">window</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="k">return</span> <span class="n">window</span>

<span class="o">=&gt;</span>

<span class="p">[{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;2018-04-30T20:18:22.918060&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;2018-04-30T20:18:23.481320&#39;</span><span class="p">}]</span>
<span class="p">[{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;2018-04-30T20:18:24.041337&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;2018-04-30T20:18:24.593545&#39;</span><span class="p">}</span>
<span class="o">...</span>
</pre></div>
</div>
<p>In this case the emitter strategy is <code class="code docutils literal notranslate"><span class="pre">CountWindow</span></code>. The following strategies are
available out of the box:</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">CountWindow</span></code> - emit fixed-sized windows. Waits until at least <em>n</em> messages are</dt><dd><p>available before emitting a new window</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">FixedTimeWindow</span></code>- emit all messages retrieved within specific, time-fixed windows of</dt><dd><p>a given interval of <em>n</em> seconds. This guarnatees that messages were received in the specific
window.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">RelaxedTimeWindow</span></code> - every interval of <em>n</em> seconds emit all messages retrieved since</dt><dd><p>the last window was created. This does not guarantee that messages were received in a given
window.</p>
</dd>
</dl>
</li>
</ul>
</section>
<section id="implementing-a-custom-windowemitter">
<h2>Implementing a custom WindowEmitter<a class="headerlink" href="#implementing-a-custom-windowemitter" title="Link to this heading">¶</a></h2>
<p>Custom emitter strategies are implemented as a subclass to <code class="code docutils literal notranslate"><span class="pre">WindowEmitter</span></code>. The main methods
to implement are</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">window_ready</span></code> - returns the tuple <code class="code docutils literal notranslate"><span class="pre">(ready,</span> <span class="pre">data)</span></code>, where ready is True if there is data</dt><dd><p>to emit</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">query</span></code> - returns the data for the new window. This function retrieves the <code class="code docutils literal notranslate"><span class="pre">data</span></code> part</dt><dd><p>of the return value of <code class="code docutils literal notranslate"><span class="pre">window_ready</span></code></p>
</dd>
</dl>
</li>
</ul>
<p>See the API reference for more details.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SortedWindow</span><span class="p">(</span><span class="n">WindowEmitter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    sort all data by value and output only multiples of 2 in batches of interval size</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">window_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Buffer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">no_cache</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">processed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">obj</span> <span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="runtimes.html" class="btn btn-neutral float-left" title="Runtime Clusters" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../admin/index.html" class="btn btn-neutral float-right" title="Administration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022 (c) omegaml.io by one2seven GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>

      </div>
    </section>
  </div>
  <!-- version plugin for rtd template without sidebar -->
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: 0.12.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../0.11.3/guide/streaming.html" class="version-ref-0.11.3">0.11.3</a></dd>
      <dd><a href="../../0.11.4/guide/streaming.html" class="version-ref-0.11.4">0.11.4</a></dd>
      <dd><a href="streaming.html" class="version-ref-0.12.0">0.12.0</a></dd>
      <dd><a href="../../0.13.0/guide/streaming.html" class="version-ref-0.13.0">0.13.0</a></dd>
      <dd><a href="../../0.13.2/guide/streaming.html" class="version-ref-0.13.2">0.13.2</a></dd>
      <dd><a href="../../0.13.4/guide/streaming.html" class="version-ref-0.13.4">0.13.4</a></dd>
      <dd><a href="../../0.13.5/guide/streaming.html" class="version-ref-0.13.5">0.13.5</a></dd>
      <dd><a href="../../0.13.6/guide/streaming.html" class="version-ref-0.13.6">0.13.6</a></dd>
      <dd><a href="../../0.13.7/index.html" class="version-ref-0.13.7">0.13.7</a></dd>
      <dd><a href="../../0.14.0/index.html" class="version-ref-0.14.0">0.14.0</a></dd>
      <dd><a href="../../0.15.1/index.html" class="version-ref-0.15.1">0.15.1</a></dd>
      <dd><a href="../../0.15.2/index.html" class="version-ref-0.15.2">0.15.2</a></dd>
      <dd><a href="../../latest/index.html" class="version-ref-latest">latest</a></dd>
      <dd><a href="../../release/0.15.3/index.html" class="version-ref-release/0.15.3">0.15.3</a></dd>
      <dd><a href="../../release/0.15.5/index.html" class="version-ref-release/0.15.5">0.15.5</a></dd>
      <dd><a href="../../release/0.16.0/index.html" class="version-ref-release/0.16.0">0.16.0</a></dd>
      <dd><a href="../../release/0.16.1/index.html" class="version-ref-release/0.16.1">0.16.1</a></dd>
      <dd><a href="../../release/0.16.2/index.html" class="version-ref-release/0.16.2">0.16.2</a></dd>
      <dd><a href="../../release/0.16.3/index.html" class="version-ref-release/0.16.3">0.16.3</a></dd>
      <dd><a href="../../release/0.16.4/index.html" class="version-ref-release/0.16.4">0.16.4</a></dd>
      <dd><a href="../../release/0.4/index.html" class="version-ref-release/0.4">0.4</a></dd>
      <dd><a href="../../release/0.5/index.html" class="version-ref-release/0.5">0.5</a></dd>
      <dd><a href="../../release/0.9/guide/streaming.html" class="version-ref-release/0.9">0.9</a></dd>
      <dd><a href="../../stable/index.html" class="version-ref-stable">stable</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../master/index.html">master</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>