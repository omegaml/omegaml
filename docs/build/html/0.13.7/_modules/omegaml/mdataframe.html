

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>omegaml.mdataframe &mdash; omega-ml 1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=7ca4e891" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=56dcb7b8"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            omega-ml
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devguide/index.html">Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nb/index.html">Tutorial Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../screenshots.html">Screenshots</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">omega-ml</a>
      </nav>

      <div class="wy-nav-content">

<div class="version-warning-banner">
    
    You're reading the documentation for a development version.
    For the latest released version, please have a look at <a href="../../../release/0.17.0/index.html">release/0.17.0</a>.
    
</div>


        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">omegaml.mdataframe</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for omegaml.mdataframe</h1><div class="highlight"><pre>
<span></span><span class="linenos">   1</span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">absolute_import</span>
<span class="linenos">   2</span>
<span class="linenos">   3</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos">   4</span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="linenos">   5</span><span class="kn">from</span><span class="w"> </span><span class="nn">bson</span><span class="w"> </span><span class="kn">import</span> <span class="n">Code</span>
<span class="linenos">   6</span><span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">isscalar</span>
<span class="linenos">   7</span><span class="kn">from</span><span class="w"> </span><span class="nn">pymongo.collection</span><span class="w"> </span><span class="kn">import</span> <span class="n">Collection</span>
<span class="linenos">   8</span><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">uuid4</span>
<span class="linenos">   9</span>
<span class="linenos">  10</span><span class="kn">from</span><span class="w"> </span><span class="nn">omegaml.store</span><span class="w"> </span><span class="kn">import</span> <span class="n">qops</span>
<span class="linenos">  11</span><span class="kn">from</span><span class="w"> </span><span class="nn">omegaml.store.filtered</span><span class="w"> </span><span class="kn">import</span> <span class="n">FilteredCollection</span>
<span class="linenos">  12</span><span class="kn">from</span><span class="w"> </span><span class="nn">omegaml.store.query</span><span class="w"> </span><span class="kn">import</span> <span class="n">Filter</span><span class="p">,</span> <span class="n">MongoQ</span>
<span class="linenos">  13</span><span class="kn">from</span><span class="w"> </span><span class="nn">omegaml.store.queryops</span><span class="w"> </span><span class="kn">import</span> <span class="n">MongoQueryOps</span>
<span class="linenos">  14</span><span class="kn">from</span><span class="w"> </span><span class="nn">omegaml.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_tuple</span><span class="p">,</span> <span class="n">make_list</span><span class="p">,</span> <span class="n">restore_index</span><span class="p">,</span> \
<span class="linenos">  15</span>    <span class="n">cursor_to_dataframe</span><span class="p">,</span> <span class="n">restore_index_columns_order</span><span class="p">,</span> <span class="n">PickableCollection</span><span class="p">,</span> <span class="n">extend_instance</span><span class="p">,</span> <span class="n">json_normalize</span><span class="p">,</span> <span class="n">ensure_index</span>
<span class="linenos">  16</span>
<span class="linenos">  17</span><span class="n">INSPECT_CACHE</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">  18</span>
<span class="linenos">  19</span>
<div class="viewcode-block" id="MGrouper">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MGrouper">[docs]</a>
<span class="linenos">  20</span><span class="k">class</span><span class="w"> </span><span class="nc">MGrouper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="linenos">  21</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  22</span><span class="sd">    a Grouper for MDataFrames</span>
<span class="linenos">  23</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">  24</span>    <span class="n">STATS_MAP</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">  25</span>        <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="s1">&#39;stdDevSamp&#39;</span><span class="p">,</span>
<span class="linenos">  26</span>        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="s1">&#39;avg&#39;</span><span class="p">,</span>
<span class="linenos">  27</span>    <span class="p">}</span>
<span class="linenos">  28</span>
<span class="linenos">  29</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdataframe</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="linenos">  30</span>        <span class="bp">self</span><span class="o">.</span><span class="n">mdataframe</span> <span class="o">=</span> <span class="n">mdataframe</span>
<span class="linenos">  31</span>        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>
<span class="linenos">  32</span>        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">make_tuple</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
<span class="linenos">  33</span>        <span class="bp">self</span><span class="o">.</span><span class="n">should_sort</span> <span class="o">=</span> <span class="n">sort</span>
<span class="linenos">  34</span>
<span class="linenos">  35</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
<span class="linenos">  36</span>        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<span class="linenos">  37</span>            <span class="k">return</span> <span class="n">MSeriesGroupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
<span class="linenos">  38</span>
<span class="linenos">  39</span>        <span class="k">def</span><span class="w"> </span><span class="nf">statfunc</span><span class="p">():</span>
<span class="linenos">  40</span>            <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_non_group_columns</span><span class="p">()</span>
<span class="linenos">  41</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="n">attr</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">})</span>
<span class="linenos">  42</span>
<span class="linenos">  43</span>        <span class="k">return</span> <span class="n">statfunc</span>
<span class="linenos">  44</span>
<span class="linenos">  45</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="linenos">  46</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<span class="linenos">  47</span>
<div class="viewcode-block" id="MGrouper.agg">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MGrouper.agg">[docs]</a>
<span class="linenos">  48</span>    <span class="k">def</span><span class="w"> </span><span class="nf">agg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">):</span>
<span class="linenos">  49</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  50</span><span class="sd">        shortcut for .aggregate</span>
<span class="linenos">  51</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">  52</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span></div>

<span class="linenos">  53</span>
<div class="viewcode-block" id="MGrouper.aggregate">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MGrouper.aggregate">[docs]</a>
<span class="linenos">  54</span>    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">  55</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  56</span><span class="sd">        aggregate by given specs</span>
<span class="linenos">  57</span>
<span class="linenos">  58</span><span class="sd">        See the following link for a list of supported operations.</span>
<span class="linenos">  59</span><span class="sd">        https://docs.mongodb.com/manual/reference/operator/aggregation/group/</span>
<span class="linenos">  60</span>
<span class="linenos">  61</span><span class="sd">        :param specs: a dictionary of { column : function | list[functions] }</span>
<span class="linenos">  62</span><span class="sd">           pairs.</span>
<span class="linenos">  63</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">  64</span>
<span class="linenos">  65</span>        <span class="k">def</span><span class="w"> </span><span class="nf">add_stats</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">stat</span><span class="p">):</span>
<span class="linenos">  66</span>            <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">stat</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">  67</span>                <span class="s1">&#39;$</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">MGrouper</span><span class="o">.</span><span class="n">STATS_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">stat</span><span class="p">):</span> <span class="s1">&#39;$</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">column</span><span class="p">}</span>
<span class="linenos">  68</span>
<span class="linenos">  69</span>        <span class="c1"># generate $group command</span>
<span class="linenos">  70</span>        <span class="n">_specs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">  71</span>        <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">specs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">  72</span>            <span class="n">stats</span> <span class="o">=</span> <span class="n">make_tuple</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
<span class="linenos">  73</span>            <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
<span class="linenos">  74</span>                <span class="n">add_stats</span><span class="p">(</span><span class="n">_specs</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">stat</span><span class="p">)</span>
<span class="linenos">  75</span>        <span class="n">groupby</span> <span class="o">=</span> <span class="n">qops</span><span class="o">.</span><span class="n">GROUP</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
<span class="linenos">  76</span>                             <span class="o">**</span><span class="n">_specs</span><span class="p">)</span>
<span class="linenos">  77</span>        <span class="c1"># execute and return a dataframe</span>
<span class="linenos">  78</span>        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amend_pipeline</span><span class="p">([</span><span class="n">groupby</span><span class="p">])</span>
<span class="linenos">  79</span>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">allowDiskUse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">  80</span>
<span class="linenos">  81</span>        <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">():</span>
<span class="linenos">  82</span>            <span class="c1"># we need this to build a pipeline for from_records</span>
<span class="linenos">  83</span>            <span class="c1"># to process, otherwise the cursor will be exhausted already</span>
<span class="linenos">  84</span>            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<span class="linenos">  85</span>                <span class="n">_id</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span>
<span class="linenos">  86</span>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">  87</span>                    <span class="n">group</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_id</span><span class="p">)</span>
<span class="linenos">  88</span>                <span class="k">yield</span> <span class="n">group</span>
<span class="linenos">  89</span>
<span class="linenos">  90</span>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">get_data</span><span class="p">())</span>
<span class="linenos">  91</span>        <span class="n">columns</span> <span class="o">=</span> <span class="n">make_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="linenos">  92</span>        <span class="k">if</span> <span class="n">columns</span><span class="p">:</span>
<span class="linenos">  93</span>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">  94</span>        <span class="k">return</span> <span class="n">df</span></div>

<span class="linenos">  95</span>
<span class="linenos">  96</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_amend_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
<span class="linenos">  97</span><span class="w">        </span><span class="sd">&quot;&quot;&quot; amend pipeline with default ops on coll.aggregate() calls &quot;&quot;&quot;</span>
<span class="linenos">  98</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_sort</span><span class="p">:</span>
<span class="linenos">  99</span>            <span class="n">sort</span> <span class="o">=</span> <span class="n">qops</span><span class="o">.</span><span class="n">SORT</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">qops</span><span class="o">.</span><span class="n">make_sortkey</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)))</span>
<span class="linenos"> 100</span>            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span>
<span class="linenos"> 101</span>        <span class="k">return</span> <span class="n">pipeline</span>
<span class="linenos"> 102</span>
<span class="linenos"> 103</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_non_group_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 104</span><span class="w">        </span><span class="sd">&quot;&quot;&quot; get all columns in mdataframe that is not in columns &quot;&quot;&quot;</span>
<span class="linenos"> 105</span>        <span class="k">return</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdataframe</span><span class="o">.</span><span class="n">columns</span>
<span class="linenos"> 106</span>                <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">!=</span> <span class="s1">&#39;_id&#39;</span>
<span class="linenos"> 107</span>                <span class="ow">and</span> <span class="ow">not</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_idx&#39;</span><span class="p">)</span>
<span class="linenos"> 108</span>                <span class="ow">and</span> <span class="ow">not</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_om#&#39;</span><span class="p">)]</span>
<span class="linenos"> 109</span>
<span class="linenos"> 110</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 111</span>        <span class="n">count_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_non_group_columns</span><span class="p">()</span>
<span class="linenos"> 112</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">count_columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 113</span>            <span class="n">count_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_count&#39;</span><span class="p">)</span>
<span class="linenos"> 114</span>        <span class="n">groupby</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 115</span>            <span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos"> 116</span>                <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="s2">&quot;$</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">},</span>
<span class="linenos"> 117</span>            <span class="p">}</span>
<span class="linenos"> 118</span>        <span class="p">}</span>
<span class="linenos"> 119</span>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">count_columns</span><span class="p">:</span>
<span class="linenos"> 120</span>            <span class="n">groupby</span><span class="p">[</span><span class="s1">&#39;$group&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$sum&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="linenos"> 121</span>        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amend_pipeline</span><span class="p">([</span><span class="n">groupby</span><span class="p">])</span>
<span class="linenos"> 122</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_sort</span><span class="p">:</span>
<span class="linenos"> 123</span>            <span class="n">sort</span> <span class="o">=</span> <span class="n">qops</span><span class="o">.</span><span class="n">SORT</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">qops</span><span class="o">.</span><span class="n">make_sortkey</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)))</span>
<span class="linenos"> 124</span>            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span>
<span class="linenos"> 125</span>        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">allowDiskUse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="linenos"> 126</span>
<div class="viewcode-block" id="MGrouper.count">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MGrouper.count">[docs]</a>
<span class="linenos"> 127</span>    <span class="k">def</span><span class="w"> </span><span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 128</span><span class="w">        </span><span class="sd">&quot;&quot;&quot; return counts by group columns &quot;&quot;&quot;</span>
<span class="linenos"> 129</span>        <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">()</span>
<span class="linenos"> 130</span>        <span class="c1"># remove mongo object _id</span>
<span class="linenos"> 131</span>        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
<span class="linenos"> 132</span>            <span class="n">group</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">))</span>
<span class="linenos"> 133</span>        <span class="c1"># transform results to dataframe, then return as pandas would</span>
<span class="linenos"> 134</span>        <span class="n">resultdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">make_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
<span class="linenos"> 135</span>                                                  <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 136</span>        <span class="k">return</span> <span class="n">resultdf</span></div>

<span class="linenos"> 137</span>
<span class="linenos"> 138</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 139</span><span class="w">        </span><span class="sd">&quot;&quot;&quot; for each group returns the key and a Filter object&quot;&quot;&quot;</span>
<span class="linenos"> 140</span>        <span class="c1"># reduce count to only one column</span>
<span class="linenos"> 141</span>        <span class="n">groups</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">_count</span><span class="p">()</span>
<span class="linenos"> 142</span>        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
<span class="linenos"> 143</span>            <span class="n">keys</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span>
<span class="linenos"> 144</span>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdataframe</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
<span class="linenos"> 145</span>            <span class="k">yield</span> <span class="n">keys</span><span class="p">,</span> <span class="n">data</span></div>

<span class="linenos"> 146</span>
<span class="linenos"> 147</span>
<div class="viewcode-block" id="MLocIndexer">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MLocIndexer">[docs]</a>
<span class="linenos"> 148</span><span class="k">class</span><span class="w"> </span><span class="nc">MLocIndexer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="linenos"> 149</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 150</span><span class="sd">    implements the LocIndexer for MDataFrames</span>
<span class="linenos"> 151</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 152</span>
<span class="linenos"> 153</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdataframe</span><span class="p">,</span> <span class="n">positional</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 154</span>        <span class="bp">self</span><span class="o">.</span><span class="n">mdataframe</span> <span class="o">=</span> <span class="n">mdataframe</span>
<span class="linenos"> 155</span>        <span class="c1"># if positional, any loc[spec] will be applied on the rowid only</span>
<span class="linenos"> 156</span>        <span class="bp">self</span><span class="o">.</span><span class="n">positional</span> <span class="o">=</span> <span class="n">positional</span>
<span class="linenos"> 157</span>        <span class="c1"># indicator will be set true if loc specs are from a range type (list, tuple, np.ndarray)</span>
<span class="linenos"> 158</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_from_range</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 159</span>
<div class="viewcode-block" id="MLocIndexer.__getitem__">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MLocIndexer.__getitem__">[docs]</a>
<span class="linenos"> 160</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">):</span>
<span class="linenos"> 161</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 162</span><span class="sd">        access by index</span>
<span class="linenos"> 163</span>
<span class="linenos"> 164</span><span class="sd">        use as mdf.loc[specs] where specs is any of</span>
<span class="linenos"> 165</span>
<span class="linenos"> 166</span><span class="sd">        * a list or tuple of scalar index values, e.g. .loc[(1,2,3)]</span>
<span class="linenos"> 167</span><span class="sd">        * a slice of values e.g. .loc[1:5]</span>
<span class="linenos"> 168</span><span class="sd">        * a list of slices, e.g. .loc[1:5, 2:3]</span>
<span class="linenos"> 169</span>
<span class="linenos"> 170</span><span class="sd">        :return: the sliced part of the MDataFrame</span>
<span class="linenos"> 171</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 172</span>        <span class="n">filterq</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filter</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
<span class="linenos"> 173</span>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdataframe</span>
<span class="linenos"> 174</span>        <span class="k">if</span> <span class="n">filterq</span><span class="p">:</span>
<span class="linenos"> 175</span>            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdataframe</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">filterq</span><span class="p">)</span>
<span class="linenos"> 176</span>            <span class="n">df</span><span class="o">.</span><span class="n">from_loc_indexer</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 177</span>            <span class="n">df</span><span class="o">.</span><span class="n">from_loc_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_range</span>
<span class="linenos"> 178</span>        <span class="k">if</span> <span class="n">projection</span><span class="p">:</span>
<span class="linenos"> 179</span>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">projection</span><span class="p">]</span>
<span class="linenos"> 180</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdataframe</span><span class="p">,</span> <span class="n">MSeries</span><span class="p">):</span>
<span class="linenos"> 181</span>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">_as_mseries</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos"> 182</span>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;immediate_loc&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 183</span>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">value</span>
<span class="linenos"> 184</span>        <span class="k">return</span> <span class="n">df</span></div>

<span class="linenos"> 185</span>
<span class="linenos"> 186</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos"> 187</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
<span class="linenos"> 188</span>
<span class="linenos"> 189</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">):</span>
<span class="linenos"> 190</span>        <span class="n">filterq</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 191</span>        <span class="n">projection</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 192</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positional</span><span class="p">:</span>
<span class="linenos"> 193</span>            <span class="n">idx_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_om#rowid&#39;</span><span class="p">]</span>
<span class="linenos"> 194</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 195</span>            <span class="n">idx_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdataframe</span><span class="o">.</span><span class="n">_get_frame_index</span><span class="p">()</span>
<span class="linenos"> 196</span>        <span class="n">flt_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 197</span>        <span class="n">enumerable_types</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
<span class="linenos"> 198</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="linenos"> 199</span>            <span class="n">specs</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos"> 200</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">enumerable_types</span><span class="p">)</span>
<span class="linenos"> 201</span>                <span class="ow">and</span> <span class="n">isscalar</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<span class="linenos"> 202</span>                <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">)):</span>
<span class="linenos"> 203</span>            <span class="c1"># single column index with list of scalar values</span>
<span class="linenos"> 204</span>            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positional</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
<span class="linenos"> 205</span>                    <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">isscalar</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">)):</span>
<span class="linenos"> 206</span>                <span class="c1"># iloc[int, int] is a cell access</span>
<span class="linenos"> 207</span>                <span class="n">flt_kwargs</span><span class="p">[</span><span class="n">idx_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 208</span>                <span class="n">projection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_projection</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos"> 209</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 210</span>                <span class="n">flt_kwargs</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">__in&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">specs</span>
<span class="linenos"> 211</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_from_range</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 212</span>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
<span class="linenos"> 213</span>            <span class="n">flt_kwargs</span><span class="p">[</span><span class="n">idx_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">specs</span>
<span class="linenos"> 214</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 215</span>            <span class="n">specs</span> <span class="o">=</span> <span class="n">make_tuple</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
<span class="linenos"> 216</span>            <span class="c1"># list/tuple of slices or scalar values, or MultiIndex</span>
<span class="linenos"> 217</span>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
<span class="linenos"> 218</span>                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_cols</span><span class="p">):</span>
<span class="linenos"> 219</span>                    <span class="n">col</span> <span class="o">=</span> <span class="n">idx_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="linenos"> 220</span>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
<span class="linenos"> 221</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">_from_range</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 222</span>                        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">stop</span>
<span class="linenos"> 223</span>                        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 224</span>                            <span class="n">flt_kwargs</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">__gte&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span> <span class="o">=</span> <span class="n">start</span>
<span class="linenos"> 225</span>                        <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 226</span>                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<span class="linenos"> 227</span>                                <span class="n">stop</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positional</span><span class="p">)</span>
<span class="linenos"> 228</span>                            <span class="n">flt_kwargs</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">__lte&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span> <span class="o">=</span> <span class="n">stop</span>
<span class="linenos"> 229</span>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">enumerable_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isscalar</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<span class="linenos"> 230</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">_from_range</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 231</span>                        <span class="c1"># single column index with list of scalar values</span>
<span class="linenos"> 232</span>                        <span class="c1"># -- convert to list for PyMongo serialization</span>
<span class="linenos"> 233</span>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="linenos"> 234</span>                            <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos"> 235</span>                        <span class="n">flt_kwargs</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">__in&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span> <span class="o">=</span> <span class="n">spec</span>
<span class="linenos"> 236</span>                    <span class="k">elif</span> <span class="n">isscalar</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
<span class="linenos"> 237</span>                        <span class="n">flt_kwargs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>
<span class="linenos"> 238</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 239</span>                    <span class="c1"># we&#39;re out of index columns, let&#39;s look at columns</span>
<span class="linenos"> 240</span>                    <span class="n">cur_proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_projection</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
<span class="linenos"> 241</span>                    <span class="c1"># if we get a single column, that&#39;s the projection</span>
<span class="linenos"> 242</span>                    <span class="c1"># if we had a single column, now need to add more, create a list</span>
<span class="linenos"> 243</span>                    <span class="c1"># if we have a list already, extend that</span>
<span class="linenos"> 244</span>                    <span class="k">if</span> <span class="n">projection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 245</span>                        <span class="n">projection</span> <span class="o">=</span> <span class="n">cur_proj</span>
<span class="linenos"> 246</span>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">projection</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<span class="linenos"> 247</span>                        <span class="n">projection</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cur_proj</span><span class="p">)</span>
<span class="linenos"> 248</span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 249</span>                        <span class="n">projection</span> <span class="o">=</span> <span class="p">[</span><span class="n">projection</span><span class="p">,</span> <span class="n">cur_proj</span><span class="p">]</span>
<span class="linenos"> 250</span>        <span class="k">if</span> <span class="n">flt_kwargs</span><span class="p">:</span>
<span class="linenos"> 251</span>            <span class="n">filterq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MongoQ</span><span class="p">(</span><span class="o">**</span><span class="n">flt_kwargs</span><span class="p">))</span>
<span class="linenos"> 252</span>        <span class="n">finalq</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 253</span>        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">filterq</span><span class="p">:</span>
<span class="linenos"> 254</span>            <span class="k">if</span> <span class="n">finalq</span><span class="p">:</span>
<span class="linenos"> 255</span>                <span class="n">finalq</span> <span class="o">|=</span> <span class="n">q</span>
<span class="linenos"> 256</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 257</span>                <span class="n">finalq</span> <span class="o">=</span> <span class="n">q</span>
<span class="linenos"> 258</span>        <span class="k">return</span> <span class="n">finalq</span><span class="p">,</span> <span class="n">projection</span>
<span class="linenos"> 259</span>
<span class="linenos"> 260</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_projection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
<span class="linenos"> 261</span>        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdataframe</span><span class="o">.</span><span class="n">columns</span>
<span class="linenos"> 262</span>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
<span class="linenos"> 263</span>            <span class="k">return</span> <span class="p">[</span><span class="n">spec</span><span class="p">]</span>
<span class="linenos"> 264</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
<span class="linenos"> 265</span>            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span>
<span class="linenos"> 266</span>            <span class="k">return</span> <span class="n">spec</span>
<span class="linenos"> 267</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
<span class="linenos"> 268</span>            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">stop</span>
<span class="linenos"> 269</span>            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)):</span>
<span class="linenos"> 270</span>                <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span>
<span class="linenos"> 271</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 272</span>                <span class="n">start</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
<span class="linenos"> 273</span>                <span class="n">stop</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
<span class="linenos"> 274</span>            <span class="k">return</span> <span class="n">columns</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)]</span>
<span class="linenos"> 275</span>        <span class="k">raise</span> <span class="ne">IndexError</span></div>

<span class="linenos"> 276</span>
<span class="linenos"> 277</span>
<div class="viewcode-block" id="MPosIndexer">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MPosIndexer">[docs]</a>
<span class="linenos"> 278</span><span class="k">class</span><span class="w"> </span><span class="nc">MPosIndexer</span><span class="p">(</span><span class="n">MLocIndexer</span><span class="p">):</span>
<span class="linenos"> 279</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 280</span><span class="sd">    implements the position-based indexer for MDataFrames</span>
<span class="linenos"> 281</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 282</span>
<span class="linenos"> 283</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdataframe</span><span class="p">):</span>
<span class="linenos"> 284</span>        <span class="nb">super</span><span class="p">(</span><span class="n">MPosIndexer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">mdataframe</span><span class="p">,</span> <span class="n">positional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 285</span>
<span class="linenos"> 286</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_projection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
<span class="linenos"> 287</span>        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdataframe</span><span class="o">.</span><span class="n">columns</span>
<span class="linenos"> 288</span>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
<span class="linenos"> 289</span>            <span class="k">return</span> <span class="n">columns</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span>
<span class="linenos"> 290</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
<span class="linenos"> 291</span>            <span class="k">return</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">]</span>
<span class="linenos"> 292</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
<span class="linenos"> 293</span>            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="nb">slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="nb">slice</span><span class="o">.</span><span class="n">stop</span>
<span class="linenos"> 294</span>            <span class="k">if</span> <span class="n">start</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<span class="linenos"> 295</span>                <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 296</span>            <span class="k">if</span> <span class="n">stop</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<span class="linenos"> 297</span>                <span class="c1"># sliced ranges are inclusive</span>
<span class="linenos"> 298</span>                <span class="n">stop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
<span class="linenos"> 299</span>            <span class="k">return</span> <span class="n">columns</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)]</span>
<span class="linenos"> 300</span>        <span class="k">raise</span> <span class="ne">IndexError</span></div>

<span class="linenos"> 301</span>
<span class="linenos"> 302</span>
<span class="linenos"> 303</span><span class="k">class</span><span class="w"> </span><span class="nc">MSeriesGroupby</span><span class="p">(</span><span class="n">MGrouper</span><span class="p">):</span>
<span class="linenos"> 304</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 305</span><span class="sd">    like a MGrouper but limited to one column</span>
<span class="linenos"> 306</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 307</span>
<span class="linenos"> 308</span>    <span class="k">def</span><span class="w"> </span><span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 309</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 310</span><span class="sd">        return series count</span>
<span class="linenos"> 311</span>
<span class="linenos"> 312</span><span class="sd">        :return: counts by group</span>
<span class="linenos"> 313</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 314</span>        <span class="c1"># MGrouper will insert a _count column, see _count(). we remove</span>
<span class="linenos"> 315</span>        <span class="c1"># that column again and return a series named as the group column</span>
<span class="linenos"> 316</span>        <span class="n">resultdf</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MSeriesGroupby</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="linenos"> 317</span>        <span class="n">count_column</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">resultdf</span><span class="o">.</span><span class="n">columns</span>
<span class="linenos"> 318</span>                        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_count&#39;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 319</span>        <span class="n">new_column</span> <span class="o">=</span> <span class="n">count_column</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_count&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="linenos"> 320</span>        <span class="n">resultdf</span> <span class="o">=</span> <span class="n">resultdf</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">count_column</span><span class="p">:</span> <span class="n">new_column</span><span class="p">})</span>
<span class="linenos"> 321</span>        <span class="k">return</span> <span class="n">resultdf</span><span class="p">[</span><span class="n">new_column</span><span class="p">]</span>
<span class="linenos"> 322</span>
<span class="linenos"> 323</span>
<div class="viewcode-block" id="MDataFrame">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MDataFrame">[docs]</a>
<span class="linenos"> 324</span><span class="k">class</span><span class="w"> </span><span class="nc">MDataFrame</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="linenos"> 325</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 326</span><span class="sd">    A DataFrame for mongodb</span>
<span class="linenos"> 327</span>
<span class="linenos"> 328</span><span class="sd">    Performs out-of-core, lazy computOation on a mongodb cluster.</span>
<span class="linenos"> 329</span><span class="sd">    Behaves like a pandas DataFrame. Actual results are returned</span>
<span class="linenos"> 330</span><span class="sd">    as pandas DataFrames.</span>
<span class="linenos"> 331</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 332</span>
<span class="linenos"> 333</span>    <span class="n">STATFUNCS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span><span class="p">]</span>
<span class="linenos"> 334</span>
<span class="linenos"> 335</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 336</span>                 <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 337</span>                 <span class="n">force_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">immediate_loc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auto_inspect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 338</span>                 <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 339</span>                 <span class="n">parser</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 340</span>                 <span class="n">preparefn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_loc_range</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos"> 341</span>        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">PickableCollection</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
<span class="linenos"> 342</span>        <span class="c1"># columns in frame</span>
<span class="linenos"> 343</span>        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">make_tuple</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="k">if</span> <span class="n">columns</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fields</span><span class="p">(</span><span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">)</span>
<span class="linenos"> 344</span>        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="linenos"> 345</span>        <span class="c1"># columns to sort by, defaults to not sorted</span>
<span class="linenos"> 346</span>        <span class="bp">self</span><span class="o">.</span><span class="n">sort_order</span> <span class="o">=</span> <span class="n">sort_order</span>
<span class="linenos"> 347</span>        <span class="c1"># top n documents to fetch</span>
<span class="linenos"> 348</span>        <span class="bp">self</span><span class="o">.</span><span class="n">head_limit</span> <span class="o">=</span> <span class="n">limit</span>
<span class="linenos"> 349</span>        <span class="c1"># top n documents to skip before returning</span>
<span class="linenos"> 350</span>        <span class="bp">self</span><span class="o">.</span><span class="n">skip_topn</span> <span class="o">=</span> <span class="n">skip</span>
<span class="linenos"> 351</span>        <span class="c1"># filter criteria</span>
<span class="linenos"> 352</span>        <span class="bp">self</span><span class="o">.</span><span class="n">filter_criteria</span> <span class="o">=</span> <span class="n">query</span> <span class="ow">or</span> <span class="p">{}</span>
<span class="linenos"> 353</span>        <span class="c1"># force columns -- on output add columns not present</span>
<span class="linenos"> 354</span>        <span class="bp">self</span><span class="o">.</span><span class="n">force_columns</span> <span class="o">=</span> <span class="n">force_columns</span> <span class="ow">or</span> <span class="p">[]</span>
<span class="linenos"> 355</span>        <span class="c1"># was this created from the loc indexer?</span>
<span class="linenos"> 356</span>        <span class="bp">self</span><span class="o">.</span><span class="n">from_loc_indexer</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from_loc_indexer&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 357</span>        <span class="c1"># was the loc index used a range? Else a single value</span>
<span class="linenos"> 358</span>        <span class="bp">self</span><span class="o">.</span><span class="n">from_loc_range</span> <span class="o">=</span> <span class="n">from_loc_range</span>
<span class="linenos"> 359</span>        <span class="c1"># setup query for filter criteries, if provided</span>
<span class="linenos"> 360</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_criteria</span><span class="p">:</span>
<span class="linenos"> 361</span>            <span class="c1"># make sure we have a filtered collection with the criteria given</span>
<span class="linenos"> 362</span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_criteria</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos"> 363</span>                <span class="bp">self</span><span class="o">.</span><span class="n">query_inplace</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_criteria</span><span class="p">)</span>
<span class="linenos"> 364</span>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_criteria</span><span class="p">,</span> <span class="n">Filter</span><span class="p">):</span>
<span class="linenos"> 365</span>                <span class="bp">self</span><span class="o">.</span><span class="n">query_inplace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_criteria</span><span class="p">)</span>
<span class="linenos"> 366</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 367</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid query specification of type </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_criteria</span><span class="p">)))</span>
<span class="linenos"> 368</span>        <span class="c1"># if immediate_loc is True, .loc and .iloc always evaluate</span>
<span class="linenos"> 369</span>        <span class="bp">self</span><span class="o">.</span><span class="n">immediate_loc</span> <span class="o">=</span> <span class="n">immediate_loc</span>
<span class="linenos"> 370</span>        <span class="c1"># __array__ will return this value if it is set, set it otherwise</span>
<span class="linenos"> 371</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluated</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 372</span>        <span class="c1"># set true to automatically capture inspects on .value. retrieve using .inspect(cached=True)</span>
<span class="linenos"> 373</span>        <span class="bp">self</span><span class="o">.</span><span class="n">auto_inspect</span> <span class="o">=</span> <span class="n">auto_inspect</span>
<span class="linenos"> 374</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_inspect_cache</span> <span class="o">=</span> <span class="n">INSPECT_CACHE</span>
<span class="linenos"> 375</span>        <span class="c1"># apply mixins</span>
<span class="linenos"> 376</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_applyto</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
<span class="linenos"> 377</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_mixins</span><span class="p">()</span>
<span class="linenos"> 378</span>        <span class="c1"># parser to parse documents to dataframe</span>
<span class="linenos"> 379</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="o">=</span> <span class="n">json_normalize</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="n">parser</span>
<span class="linenos"> 380</span>        <span class="c1"># prepare function to be applied just before returning from .value</span>
<span class="linenos"> 381</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_preparefn</span> <span class="o">=</span> <span class="n">preparefn</span>
<span class="linenos"> 382</span>        <span class="c1"># keep technical fields like _id, _idx etc</span>
<span class="linenos"> 383</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="n">raw</span>
<span class="linenos"> 384</span>        <span class="c1"># metadata stored by omegaml (equiv. of metadata.kind_meta)</span>
<span class="linenos"> 385</span>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>
<span class="linenos"> 386</span>
<span class="linenos"> 387</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_mixins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos"> 388</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 389</span><span class="sd">        apply mixins in defaults.OMEGA_MDF_MIXINS</span>
<span class="linenos"> 390</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 391</span>        <span class="kn">from</span><span class="w"> </span><span class="nn">omegaml</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="linenos"> 392</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="n">settings</span><span class="p">()</span>
<span class="linenos"> 393</span>        <span class="k">for</span> <span class="n">mixin</span><span class="p">,</span> <span class="n">applyto</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">OMEGA_MDF_MIXINS</span><span class="p">:</span>
<span class="linenos"> 394</span>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_applyto</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">applyto</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)):</span>
<span class="linenos"> 395</span>                <span class="n">extend_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mixin</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 396</span>
<span class="linenos"> 397</span>    <span class="k">def</span><span class="w"> </span><span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 398</span>        <span class="c1"># pickle support. note that the hard work is done in PickableCollection</span>
<span class="linenos"> 399</span>        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="linenos"> 400</span>        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_evaluated</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 401</span>        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_inspect_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 402</span>        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">auto_inspect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_inspect</span><span class="p">)</span>
<span class="linenos"> 403</span>        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_preparefn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_preparefn</span><span class="p">)</span>
<span class="linenos"> 404</span>        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_parser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="p">)</span>
<span class="linenos"> 405</span>        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="p">)</span>
<span class="linenos"> 406</span>        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
<span class="linenos"> 407</span>        <span class="k">return</span> <span class="n">data</span>
<span class="linenos"> 408</span>
<span class="linenos"> 409</span>    <span class="k">def</span><span class="w"> </span><span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 410</span>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span>
<span class="linenos"> 411</span>        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
<span class="linenos"> 412</span>        <span class="k">return</span> <span class="n">_mdf_remake</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span>
<span class="linenos"> 413</span>
<span class="linenos"> 414</span>    <span class="k">def</span><span class="w"> </span><span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="linenos"> 415</span>        <span class="c1"># pickle support. note that the hard work is done in PickableCollection</span>
<span class="linenos"> 416</span>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos"> 417</span>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<span class="linenos"> 418</span>
<span class="linenos"> 419</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_getcopy_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">without</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 420</span><span class="w">        </span><span class="sd">&quot;&quot;&quot; return all parameters required on a copy of this MDataFrame &quot;&quot;&quot;</span>
<span class="linenos"> 421</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
<span class="linenos"> 422</span>                      <span class="n">sort_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_order</span><span class="p">,</span>
<span class="linenos"> 423</span>                      <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">head_limit</span><span class="p">,</span>
<span class="linenos"> 424</span>                      <span class="n">skip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_topn</span><span class="p">,</span>
<span class="linenos"> 425</span>                      <span class="n">from_loc_indexer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">from_loc_indexer</span><span class="p">,</span>
<span class="linenos"> 426</span>                      <span class="n">from_loc_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">from_loc_range</span><span class="p">,</span>
<span class="linenos"> 427</span>                      <span class="n">immediate_loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">immediate_loc</span><span class="p">,</span>
<span class="linenos"> 428</span>                      <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
<span class="linenos"> 429</span>                      <span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_criteria</span><span class="p">,</span>
<span class="linenos"> 430</span>                      <span class="n">auto_inspect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_inspect</span><span class="p">,</span>
<span class="linenos"> 431</span>                      <span class="n">parser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="p">,</span>
<span class="linenos"> 432</span>                      <span class="n">preparefn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_preparefn</span><span class="p">)</span>
<span class="linenos"> 433</span>        <span class="p">[</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">make_tuple</span><span class="p">(</span><span class="n">without</span> <span class="ow">or</span> <span class="p">[])]</span>
<span class="linenos"> 434</span>        <span class="k">return</span> <span class="n">kwargs</span>
<span class="linenos"> 435</span>
<span class="linenos"> 436</span>    <span class="k">def</span><span class="w"> </span><span class="nf">__array__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 437</span>        <span class="c1"># FIXME inefficient. make MDataFrame a drop-in replacement for any numpy ndarray</span>
<span class="linenos"> 438</span>        <span class="c1"># this evaluates every single time</span>
<span class="linenos"> 439</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluated</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 440</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_evaluated</span> <span class="o">=</span> <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span>
<span class="linenos"> 441</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 442</span>            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluated</span>
<span class="linenos"> 443</span>        <span class="k">return</span> <span class="n">array</span>
<span class="linenos"> 444</span>
<span class="linenos"> 445</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
<span class="linenos"> 446</span>        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">MDataFrame</span><span class="o">.</span><span class="n">STATFUNCS</span><span class="p">:</span>
<span class="linenos"> 447</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">statfunc</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
<span class="linenos"> 448</span>        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<span class="linenos"> 449</span>            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getcopy_kwargs</span><span class="p">()</span>
<span class="linenos"> 450</span>            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">attr</span><span class="p">)</span>
<span class="linenos"> 451</span>            <span class="k">return</span> <span class="n">MSeries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 452</span>        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
<span class="linenos"> 453</span>
<span class="linenos"> 454</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols_or_slice</span><span class="p">):</span>
<span class="linenos"> 455</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 456</span><span class="sd">        select and project by column, columns, slice, masked-style filter</span>
<span class="linenos"> 457</span>
<span class="linenos"> 458</span><span class="sd">        Masked-style filters work similar to pd.DataFrame/Series masks</span>
<span class="linenos"> 459</span><span class="sd">        but do not actually return masks but an instance of Filter. A</span>
<span class="linenos"> 460</span><span class="sd">        Filter is a delayed evaluation on the data frame.</span>
<span class="linenos"> 461</span>
<span class="linenos"> 462</span><span class="sd">            # select all rows where any column is == 5</span>
<span class="linenos"> 463</span><span class="sd">            mdf = MDataFrame(coll)</span>
<span class="linenos"> 464</span><span class="sd">            flt = mdf == 5</span>
<span class="linenos"> 465</span><span class="sd">            mdf[flt]</span>
<span class="linenos"> 466</span><span class="sd">            =&gt;</span>
<span class="linenos"> 467</span>
<span class="linenos"> 468</span><span class="sd">        :param cols_or_slice: single column (str), multi-columns (list),</span>
<span class="linenos"> 469</span><span class="sd">          slice to select columns or a masked-style</span>
<span class="linenos"> 470</span><span class="sd">        :return: filtered MDataFrame or MSeries</span>
<span class="linenos"> 471</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 472</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cols_or_slice</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos"> 473</span>            <span class="c1"># column name =&gt; MSeries</span>
<span class="linenos"> 474</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_mseries</span><span class="p">(</span><span class="n">cols_or_slice</span><span class="p">)</span>
<span class="linenos"> 475</span>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cols_or_slice</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<span class="linenos"> 476</span>            <span class="c1"># column number =&gt; MSeries</span>
<span class="linenos"> 477</span>            <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">cols_or_slice</span><span class="p">]</span>
<span class="linenos"> 478</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_mseries</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
<span class="linenos"> 479</span>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cols_or_slice</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
<span class="linenos"> 480</span>            <span class="c1"># list of column names =&gt; MDataFrame subset on columns</span>
<span class="linenos"> 481</span>            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getcopy_kwargs</span><span class="p">()</span>
<span class="linenos"> 482</span>            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols_or_slice</span><span class="p">)</span>
<span class="linenos"> 483</span>            <span class="k">return</span> <span class="n">MDataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 484</span>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cols_or_slice</span><span class="p">,</span> <span class="n">Filter</span><span class="p">):</span>
<span class="linenos"> 485</span>            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getcopy_kwargs</span><span class="p">()</span>
<span class="linenos"> 486</span>            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">cols_or_slice</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
<span class="linenos"> 487</span>            <span class="k">return</span> <span class="n">MDataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 488</span>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cols_or_slice</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="linenos"> 489</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">cols_or_slice</span><span class="p">]</span>
<span class="linenos"> 490</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown accessor type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">cols_or_slice</span><span class="p">))</span>
<span class="linenos"> 491</span>
<span class="linenos"> 492</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos"> 493</span>        <span class="c1"># True for any scalar type, numeric, bool, string</span>
<span class="linenos"> 494</span>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="linenos"> 495</span>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_criteria</span><span class="p">,</span>
<span class="linenos"> 496</span>                                                 <span class="n">update</span><span class="o">=</span><span class="n">qops</span><span class="o">.</span><span class="n">SET</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
<span class="linenos"> 497</span>            <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
<span class="linenos"> 498</span>        <span class="k">return</span> <span class="bp">self</span>
<span class="linenos"> 499</span>
<span class="linenos"> 500</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos"> 501</span>        <span class="c1"># convenience method to clone itself with updates</span>
<span class="linenos"> 502</span>        <span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span> <span class="k">if</span> <span class="n">collection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span>
<span class="linenos"> 503</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos"> 504</span>                              <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_getcopy_kwargs</span><span class="p">(</span><span class="n">without</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
<span class="linenos"> 505</span>
<span class="linenos"> 506</span>    <span class="k">def</span><span class="w"> </span><span class="nf">statfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stat</span><span class="p">):</span>
<span class="linenos"> 507</span>        <span class="n">aggr</span> <span class="o">=</span> <span class="n">MGrouper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="p">[],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 508</span>        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">aggr</span><span class="p">,</span> <span class="n">stat</span><span class="p">)</span>
<span class="linenos"> 509</span>
<div class="viewcode-block" id="MDataFrame.groupby">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MDataFrame.groupby">[docs]</a>
<span class="linenos"> 510</span>    <span class="k">def</span><span class="w"> </span><span class="nf">groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="linenos"> 511</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 512</span><span class="sd">        Group by a given set of columns</span>
<span class="linenos"> 513</span>
<span class="linenos"> 514</span><span class="sd">        :param columns: the list of columns</span>
<span class="linenos"> 515</span><span class="sd">        :param sort: if True sort by group key</span>
<span class="linenos"> 516</span><span class="sd">        :return: MGrouper</span>
<span class="linenos"> 517</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 518</span>        <span class="k">return</span> <span class="n">MGrouper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">)</span></div>

<span class="linenos"> 519</span>
<span class="linenos"> 520</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 521</span>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 522</span>        <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
<span class="linenos"> 523</span>        <span class="k">if</span> <span class="n">doc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 524</span>            <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
<span class="linenos"> 525</span>                <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="linenos"> 526</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 527</span>                <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="linenos"> 528</span>                          <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s1">&#39;_id&#39;</span>
<span class="linenos"> 529</span>                          <span class="ow">and</span> <span class="ow">not</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_idx&#39;</span><span class="p">)</span>
<span class="linenos"> 530</span>                          <span class="ow">and</span> <span class="ow">not</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_om#&#39;</span><span class="p">)]</span>
<span class="linenos"> 531</span>        <span class="k">return</span> <span class="n">result</span>
<span class="linenos"> 532</span>
<span class="linenos"> 533</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_frame_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 534</span><span class="w">        </span><span class="sd">&quot;&quot;&quot; return the dataframe&#39;s index columns &quot;&quot;&quot;</span>
<span class="linenos"> 535</span>        <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
<span class="linenos"> 536</span>        <span class="k">if</span> <span class="n">doc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 537</span>            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 538</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 539</span>            <span class="n">result</span> <span class="o">=</span> <span class="n">restore_index_columns_order</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="linenos"> 540</span>        <span class="k">return</span> <span class="n">result</span>
<span class="linenos"> 541</span>
<span class="linenos"> 542</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_frame_om_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 543</span><span class="w">        </span><span class="sd">&quot;&quot;&quot; return the dataframe&#39;s omega special fields columns &quot;&quot;&quot;</span>
<span class="linenos"> 544</span>        <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
<span class="linenos"> 545</span>        <span class="k">if</span> <span class="n">doc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 546</span>            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 547</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 548</span>            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_om#&#39;</span><span class="p">)]</span>
<span class="linenos"> 549</span>        <span class="k">return</span> <span class="n">result</span>
<span class="linenos"> 550</span>
<span class="linenos"> 551</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_as_mseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
<span class="linenos"> 552</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getcopy_kwargs</span><span class="p">()</span>
<span class="linenos"> 553</span>        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
<span class="linenos"> 554</span>        <span class="k">return</span> <span class="n">MSeries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 555</span>
<div class="viewcode-block" id="MDataFrame.inspect">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MDataFrame.inspect">[docs]</a>
<span class="linenos"> 556</span>    <span class="k">def</span><span class="w"> </span><span class="nf">inspect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">explain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 557</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 558</span><span class="sd">        inspect this dataframe&#39;s actual mongodb query</span>
<span class="linenos"> 559</span>
<span class="linenos"> 560</span><span class="sd">        :param explain: if True explains access path</span>
<span class="linenos"> 561</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 562</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cached</span><span class="p">:</span>
<span class="linenos"> 563</span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">FilteredCollection</span><span class="p">):</span>
<span class="linenos"> 564</span>                <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">query</span>
<span class="linenos"> 565</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 566</span>                <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
<span class="linenos"> 567</span>            <span class="k">if</span> <span class="n">explain</span><span class="p">:</span>
<span class="linenos"> 568</span>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">cursor</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cursor</span><span class="p">()</span>
<span class="linenos"> 569</span>                <span class="n">explain</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">explain</span><span class="p">()</span>
<span class="linenos"> 570</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 571</span>                <span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
<span class="linenos"> 572</span>                <span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
<span class="linenos"> 573</span>                <span class="s1">&#39;explain&#39;</span><span class="p">:</span> <span class="n">explain</span> <span class="ow">or</span> <span class="s1">&#39;specify explain=True&#39;</span>
<span class="linenos"> 574</span>            <span class="p">}</span>
<span class="linenos"> 575</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 576</span>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inspect_cache</span>
<span class="linenos"> 577</span>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">raw</span> <span class="ow">or</span> <span class="n">explain</span><span class="p">):</span>
<span class="linenos"> 578</span>            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="linenos"> 579</span>        <span class="k">return</span> <span class="n">data</span></div>

<span class="linenos"> 580</span>
<span class="linenos"> 581</span>    <span class="k">def</span><span class="w"> </span><span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 582</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 583</span><span class="sd">        projected number of rows when resolving</span>
<span class="linenos"> 584</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 585</span>        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="linenos"> 586</span>        <span class="n">counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
<span class="linenos"> 587</span>            <span class="n">col</span><span class="p">:</span> <span class="n">nrows</span>
<span class="linenos"> 588</span>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="linenos"> 589</span>        <span class="k">return</span> <span class="n">counts</span>
<span class="linenos"> 590</span>
<div class="viewcode-block" id="MDataFrame.__len__">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MDataFrame.__len__">[docs]</a>
<span class="linenos"> 591</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 592</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 593</span><span class="sd">        the projected number of rows when resolving</span>
<span class="linenos"> 594</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 595</span>        <span class="c1"># we reduce to just 1 column to reduce speed</span>
<span class="linenos"> 596</span>        <span class="n">short</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
<span class="linenos"> 597</span>        <span class="n">short</span> <span class="o">=</span> <span class="n">short</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">short</span>
<span class="linenos"> 598</span>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">short</span><span class="o">.</span><span class="n">_get_cursor</span><span class="p">())</span></div>

<span class="linenos"> 599</span>
<span class="linenos"> 600</span>    <span class="nd">@property</span>
<span class="linenos"> 601</span>    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 602</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 603</span><span class="sd">        return shape of dataframe</span>
<span class="linenos"> 604</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 605</span>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="linenos"> 606</span>
<span class="linenos"> 607</span>    <span class="nd">@property</span>
<span class="linenos"> 608</span>    <span class="k">def</span><span class="w"> </span><span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 609</span>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="linenos"> 610</span>
<span class="linenos"> 611</span>    <span class="nd">@property</span>
<span class="linenos"> 612</span>    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 613</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 614</span><span class="sd">        resolve the query and return a Pandas DataFrame</span>
<span class="linenos"> 615</span>
<span class="linenos"> 616</span><span class="sd">        :return: the result of the query as a pandas DataFrame</span>
<span class="linenos"> 617</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 618</span>        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cursor</span><span class="p">()</span>
<span class="linenos"> 619</span>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataframe_from_cursor</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
<span class="linenos"> 620</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_inspect</span><span class="p">:</span>
<span class="linenos"> 621</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_inspect_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">explain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="linenos"> 622</span>        <span class="c1"># this ensures the equiv. of pandas df.loc[n] is a Series</span>
<span class="linenos"> 623</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_loc_indexer</span><span class="p">:</span>
<span class="linenos"> 624</span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_loc_range</span><span class="p">:</span>
<span class="linenos"> 625</span>                <span class="n">idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
<span class="linenos"> 626</span>                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span>
<span class="linenos"> 627</span>                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
<span class="linenos"> 628</span>                <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
<span class="linenos"> 629</span>                    <span class="c1"># single row single dimension, numeric index only</span>
<span class="linenos"> 630</span>                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 631</span>            <span class="k">elif</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_loc_range</span><span class="p">:</span>
<span class="linenos"> 632</span>                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
<span class="linenos"> 633</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preparefn</span><span class="p">:</span>
<span class="linenos"> 634</span>            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preparefn</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="linenos"> 635</span>        <span class="k">return</span> <span class="n">df</span>
<span class="linenos"> 636</span>
<span class="linenos"> 637</span>    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 638</span>        <span class="c1"># TODO if head(), tail(), query(), .loc/iloc should return a new MDataFrame instance to avoid having a reset need</span>
<span class="linenos"> 639</span>        <span class="bp">self</span><span class="o">.</span><span class="n">head_limit</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 640</span>        <span class="bp">self</span><span class="o">.</span><span class="n">skip_topn</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 641</span>        <span class="bp">self</span><span class="o">.</span><span class="n">filter_criteria</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 642</span>        <span class="bp">self</span><span class="o">.</span><span class="n">force_columns</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 643</span>        <span class="bp">self</span><span class="o">.</span><span class="n">sort_order</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 644</span>        <span class="bp">self</span><span class="o">.</span><span class="n">from_loc_indexer</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 645</span>        <span class="k">return</span> <span class="bp">self</span>
<span class="linenos"> 646</span>
<span class="linenos"> 647</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_dataframe_from_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
<span class="linenos"> 648</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 649</span><span class="sd">        from the given cursor return a DataFrame</span>
<span class="linenos"> 650</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 651</span>        <span class="n">df</span> <span class="o">=</span> <span class="n">cursor_to_dataframe</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="p">)</span>
<span class="linenos"> 652</span>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restore_dataframe_proper</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="linenos"> 653</span>        <span class="k">return</span> <span class="n">df</span>
<span class="linenos"> 654</span>
<span class="linenos"> 655</span>    <span class="nd">@property</span>
<span class="linenos"> 656</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_index_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 657</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;idx_meta&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>
<span class="linenos"> 658</span>
<span class="linenos"> 659</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_restore_dataframe_proper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="linenos"> 660</span>        <span class="n">df</span> <span class="o">=</span> <span class="n">restore_index</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_meta</span><span class="p">)</span>
<span class="linenos"> 661</span>        <span class="k">if</span> <span class="s1">&#39;_id&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="p">:</span>
<span class="linenos"> 662</span>            <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 663</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_columns</span><span class="p">:</span>
<span class="linenos"> 664</span>            <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force_columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="linenos"> 665</span>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">:</span>
<span class="linenos"> 666</span>                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
<span class="linenos"> 667</span>        <span class="k">return</span> <span class="n">df</span>
<span class="linenos"> 668</span>
<span class="linenos"> 669</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 670</span>        <span class="n">projection</span> <span class="o">=</span> <span class="n">make_tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="linenos"> 671</span>        <span class="n">projection</span> <span class="o">+=</span> <span class="n">make_tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_index</span><span class="p">())</span>
<span class="linenos"> 672</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_order</span><span class="p">:</span>
<span class="linenos"> 673</span>            <span class="c1"># implicit sort</span>
<span class="linenos"> 674</span>            <span class="n">projection</span> <span class="o">+=</span> <span class="n">make_tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_om_fields</span><span class="p">())</span>
<span class="linenos"> 675</span>        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
<span class="linenos"> 676</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_order</span><span class="p">:</span>
<span class="linenos"> 677</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">qops</span><span class="o">.</span><span class="n">make_sortkey</span><span class="p">(</span><span class="n">make_tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_order</span><span class="p">)))</span>
<span class="linenos"> 678</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_limit</span><span class="p">:</span>
<span class="linenos"> 679</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_limit</span><span class="p">)</span>
<span class="linenos"> 680</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_topn</span><span class="p">:</span>
<span class="linenos"> 681</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_topn</span><span class="p">)</span>
<span class="linenos"> 682</span>        <span class="k">return</span> <span class="n">cursor</span>
<span class="linenos"> 683</span>
<div class="viewcode-block" id="MDataFrame.sort">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MDataFrame.sort">[docs]</a>
<span class="linenos"> 684</span>    <span class="k">def</span><span class="w"> </span><span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
<span class="linenos"> 685</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 686</span><span class="sd">        sort by specified columns</span>
<span class="linenos"> 687</span>
<span class="linenos"> 688</span><span class="sd">        :param columns: str of single column or a list of columns. Sort order</span>
<span class="linenos"> 689</span><span class="sd">                        is specified as the + (ascending) or - (descending)</span>
<span class="linenos"> 690</span><span class="sd">                        prefix to the column name. Default sort order is</span>
<span class="linenos"> 691</span><span class="sd">                        ascending.</span>
<span class="linenos"> 692</span><span class="sd">        :return: the MDataFrame</span>
<span class="linenos"> 693</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 694</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluated</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 695</span>        <span class="bp">self</span><span class="o">.</span><span class="n">sort_order</span> <span class="o">=</span> <span class="n">make_tuple</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
<span class="linenos"> 696</span>        <span class="k">return</span> <span class="bp">self</span></div>

<span class="linenos"> 697</span>
<div class="viewcode-block" id="MDataFrame.head">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MDataFrame.head">[docs]</a>
<span class="linenos"> 698</span>    <span class="k">def</span><span class="w"> </span><span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="linenos"> 699</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 700</span><span class="sd">        return up to limit numbers of rows</span>
<span class="linenos"> 701</span>
<span class="linenos"> 702</span><span class="sd">        :param limit: the number of rows to return. Defaults to 10</span>
<span class="linenos"> 703</span><span class="sd">        :return: the MDataFrame</span>
<span class="linenos"> 704</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 705</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span></div>

<span class="linenos"> 706</span>
<span class="linenos"> 707</span>    <span class="k">def</span><span class="w"> </span><span class="nf">tail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="linenos"> 708</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 709</span><span class="sd">        return up to limit number of rows from last inserted values</span>
<span class="linenos"> 710</span>
<span class="linenos"> 711</span><span class="sd">        :param limit:</span>
<span class="linenos"> 712</span><span class="sd">        :return:</span>
<span class="linenos"> 713</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 714</span>        <span class="n">tail_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-</span> <span class="n">limit</span><span class="p">)</span>
<span class="linenos"> 715</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">skip</span><span class="o">=</span><span class="n">tail_n</span><span class="p">)</span>
<span class="linenos"> 716</span>
<div class="viewcode-block" id="MDataFrame.skip">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MDataFrame.skip">[docs]</a>
<span class="linenos"> 717</span>    <span class="k">def</span><span class="w"> </span><span class="nf">skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topn</span><span class="p">):</span>
<span class="linenos"> 718</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 719</span><span class="sd">        skip the topn number of rows</span>
<span class="linenos"> 720</span>
<span class="linenos"> 721</span><span class="sd">        :param topn: the number of rows to skip.</span>
<span class="linenos"> 722</span><span class="sd">        :return: the MDataFrame</span>
<span class="linenos"> 723</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 724</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">skip</span><span class="o">=</span><span class="n">topn</span><span class="p">)</span></div>

<span class="linenos"> 725</span>
<div class="viewcode-block" id="MDataFrame.merge">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MDataFrame.merge">[docs]</a>
<span class="linenos"> 726</span>    <span class="k">def</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 727</span>              <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="s1">&#39;_y&#39;</span><span class="p">),</span>
<span class="linenos"> 728</span>              <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inspect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 729</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 730</span><span class="sd">        merge this dataframe with another dataframe. only left outer joins</span>
<span class="linenos"> 731</span><span class="sd">        are currently supported. the output is saved as a new collection,</span>
<span class="linenos"> 732</span><span class="sd">        target name (defaults to a generated name if not specified).</span>
<span class="linenos"> 733</span>
<span class="linenos"> 734</span><span class="sd">        :param right: the other MDataFrame</span>
<span class="linenos"> 735</span><span class="sd">        :param on: the list of key columns to merge by</span>
<span class="linenos"> 736</span><span class="sd">        :param left_on: the list of the key columns to merge on this dataframe</span>
<span class="linenos"> 737</span><span class="sd">        :param right_on: the list of the key columns to merge on the other</span>
<span class="linenos"> 738</span><span class="sd">           dataframe</span>
<span class="linenos"> 739</span><span class="sd">        :param how: the method to merge. supported are left, inner, right.</span>
<span class="linenos"> 740</span><span class="sd">           Defaults to inner</span>
<span class="linenos"> 741</span><span class="sd">        :param target: the name of the collection to store the merge results</span>
<span class="linenos"> 742</span><span class="sd">           in. If not provided a temporary name will be created.</span>
<span class="linenos"> 743</span><span class="sd">        :param suffixes: the suffixes to apply to identical left and right</span>
<span class="linenos"> 744</span><span class="sd">           columns</span>
<span class="linenos"> 745</span><span class="sd">        :param sort: if True the merge results will be sorted. If False the</span>
<span class="linenos"> 746</span><span class="sd">           MongoDB natural order is implied.</span>
<span class="linenos"> 747</span><span class="sd">        :returns: the MDataFrame to the target MDataFrame</span>
<span class="linenos"> 748</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 749</span>        <span class="c1"># validate input</span>
<span class="linenos"> 750</span>        <span class="n">supported_how</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">]</span>
<span class="linenos"> 751</span>        <span class="k">assert</span> <span class="n">how</span> <span class="ow">in</span> <span class="n">supported_how</span><span class="p">,</span> <span class="s2">&quot;only </span><span class="si">%s</span><span class="s2"> merges are currently supported&quot;</span> <span class="o">%</span> <span class="n">supported_how</span>
<span class="linenos"> 752</span>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="n">on</span><span class="p">,</span> <span class="n">left_on</span><span class="p">,</span> <span class="n">right_on</span><span class="p">]:</span>
<span class="linenos"> 753</span>            <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
<span class="linenos"> 754</span>                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
<span class="linenos"> 755</span>                    <span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;only single column merge keys are supported (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">key</span>
<span class="linenos"> 756</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="p">(</span><span class="n">Collection</span><span class="p">,</span> <span class="n">PickableCollection</span><span class="p">,</span> <span class="n">FilteredCollection</span><span class="p">)):</span>
<span class="linenos"> 757</span>            <span class="n">right</span> <span class="o">=</span> <span class="n">MDataFrame</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
<span class="linenos"> 758</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
<span class="linenos"> 759</span>            <span class="n">right</span><span class="p">,</span> <span class="n">MDataFrame</span><span class="p">),</span> <span class="s2">&quot;both must be MDataFrames, got right=%&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
<span class="linenos"> 760</span>        <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
<span class="linenos"> 761</span>            <span class="c1"># A right B == B left A</span>
<span class="linenos"> 762</span>            <span class="k">return</span> <span class="n">right</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">on</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="n">right_on</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="n">left_on</span><span class="p">,</span>
<span class="linenos"> 763</span>                               <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="n">suffixes</span><span class="p">)</span>
<span class="linenos"> 764</span>        <span class="c1"># generate lookup parameters</span>
<span class="linenos"> 765</span>        <span class="n">on</span> <span class="o">=</span> <span class="n">on</span> <span class="ow">or</span> <span class="s1">&#39;_id&#39;</span>
<span class="linenos"> 766</span>        <span class="n">right_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_collection_name_of</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
<span class="linenos"> 767</span>        <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_collection_name_of</span><span class="p">(</span>
<span class="linenos"> 768</span>            <span class="n">target</span><span class="p">,</span> <span class="s1">&#39;_temp.merge.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span>
<span class="linenos"> 769</span>        <span class="n">target_field</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos"> 770</span>                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">right_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="n">right_on</span> <span class="ow">or</span> <span class="n">on</span><span class="p">))</span>
<span class="linenos"> 771</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 772</span><span class="sd">        TODO enable filter criteria on right dataframe. requires changing LOOKUP syntax from </span>
<span class="linenos"> 773</span><span class="sd">             equitly to arbitray match </span>
<span class="linenos"> 774</span><span class="sd">        </span>
<span class="linenos"> 775</span><span class="sd">        if right.filter_criteria:</span>
<span class="linenos"> 776</span><span class="sd">            right_filter = [qops.MATCH(self._get_filter_criteria(**right.filter_criteria))]</span>
<span class="linenos"> 777</span><span class="sd">        else:</span>
<span class="linenos"> 778</span><span class="sd">            right_filter = None</span>
<span class="linenos"> 779</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 780</span>        <span class="n">right_filter</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 781</span>        <span class="n">lookup</span> <span class="o">=</span> <span class="n">qops</span><span class="o">.</span><span class="n">LOOKUP</span><span class="p">(</span><span class="n">right_name</span><span class="p">,</span>
<span class="linenos"> 782</span>                             <span class="n">key</span><span class="o">=</span><span class="n">on</span><span class="p">,</span>
<span class="linenos"> 783</span>                             <span class="n">left_key</span><span class="o">=</span><span class="n">left_on</span><span class="p">,</span>
<span class="linenos"> 784</span>                             <span class="n">right_key</span><span class="o">=</span><span class="n">right_on</span><span class="p">,</span>
<span class="linenos"> 785</span>                             <span class="n">target</span><span class="o">=</span><span class="n">target_field</span><span class="p">)</span>
<span class="linenos"> 786</span>        <span class="c1"># unwind merged documents from arrays to top-level document fields</span>
<span class="linenos"> 787</span>        <span class="n">unwind</span> <span class="o">=</span> <span class="n">qops</span><span class="o">.</span><span class="n">UNWIND</span><span class="p">(</span><span class="n">target_field</span><span class="p">,</span> <span class="n">preserve</span><span class="o">=</span><span class="n">how</span> <span class="o">!=</span> <span class="s1">&#39;inner&#39;</span><span class="p">)</span>
<span class="linenos"> 788</span>        <span class="c1"># get all fields from left, right</span>
<span class="linenos"> 789</span>        <span class="n">project</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 790</span>        <span class="k">for</span> <span class="n">left_col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<span class="linenos"> 791</span>            <span class="n">source_left_col</span> <span class="o">=</span> <span class="n">left_col</span>
<span class="linenos"> 792</span>            <span class="k">if</span> <span class="n">left_col</span> <span class="o">==</span> <span class="s1">&#39;_id&#39;</span><span class="p">:</span>
<span class="linenos"> 793</span>                <span class="n">project</span><span class="p">[</span><span class="n">left_col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos"> 794</span>                <span class="k">continue</span>
<span class="linenos"> 795</span>            <span class="k">if</span> <span class="n">left_col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_idx&#39;</span><span class="p">):</span>
<span class="linenos"> 796</span>                <span class="k">continue</span>
<span class="linenos"> 797</span>            <span class="k">if</span> <span class="n">left_col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_om#&#39;</span><span class="p">):</span>
<span class="linenos"> 798</span>                <span class="k">continue</span>
<span class="linenos"> 799</span>            <span class="k">if</span> <span class="n">left_col</span> <span class="o">!=</span> <span class="p">(</span><span class="n">on</span> <span class="ow">or</span> <span class="n">left_on</span><span class="p">)</span> <span class="ow">and</span> <span class="n">left_col</span> <span class="ow">in</span> <span class="n">right</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<span class="linenos"> 800</span>                <span class="n">left_col</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">left_col</span><span class="p">,</span> <span class="n">suffixes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos"> 801</span>            <span class="n">project</span><span class="p">[</span><span class="n">left_col</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">source_left_col</span>
<span class="linenos"> 802</span>        <span class="k">for</span> <span class="n">right_col</span> <span class="ow">in</span> <span class="n">right</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<span class="linenos"> 803</span>            <span class="k">if</span> <span class="n">right_col</span> <span class="o">==</span> <span class="s1">&#39;_id&#39;</span><span class="p">:</span>
<span class="linenos"> 804</span>                <span class="k">continue</span>
<span class="linenos"> 805</span>            <span class="k">if</span> <span class="n">right_col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_idx&#39;</span><span class="p">):</span>
<span class="linenos"> 806</span>                <span class="k">continue</span>
<span class="linenos"> 807</span>            <span class="k">if</span> <span class="n">right_col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_om#&#39;</span><span class="p">):</span>
<span class="linenos"> 808</span>                <span class="k">continue</span>
<span class="linenos"> 809</span>            <span class="k">if</span> <span class="n">right_col</span> <span class="o">==</span> <span class="p">(</span><span class="n">on</span> <span class="ow">or</span> <span class="n">right_on</span><span class="p">)</span> <span class="ow">and</span> <span class="n">right_col</span> <span class="o">==</span> <span class="p">(</span><span class="n">on</span> <span class="ow">or</span> <span class="n">left_on</span><span class="p">):</span>
<span class="linenos"> 810</span>                <span class="c1"># if the merge field is the same in both frames, we already</span>
<span class="linenos"> 811</span>                <span class="c1"># have it from left</span>
<span class="linenos"> 812</span>                <span class="k">continue</span>
<span class="linenos"> 813</span>            <span class="k">if</span> <span class="n">right_col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<span class="linenos"> 814</span>                <span class="n">left_col</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">right_col</span><span class="p">,</span> <span class="n">suffixes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos"> 815</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 816</span>                <span class="n">left_col</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">right_col</span>
<span class="linenos"> 817</span>            <span class="n">project</span><span class="p">[</span><span class="n">left_col</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;$</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_field</span><span class="p">,</span> <span class="n">right_col</span><span class="p">)</span>
<span class="linenos"> 818</span>        <span class="n">expected_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="linenos"> 819</span>        <span class="k">if</span> <span class="s1">&#39;_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">project</span><span class="p">:</span>
<span class="linenos"> 820</span>            <span class="n">project</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># never copy objectids to avoid duplicate keys, unless requested</span>
<span class="linenos"> 821</span>        <span class="n">project</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="n">project</span><span class="p">}</span>
<span class="linenos"> 822</span>        <span class="c1"># store merged documents and return an MDataFrame to it</span>
<span class="linenos"> 823</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">qops</span><span class="o">.</span><span class="n">OUT</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
<span class="linenos"> 824</span>        <span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span><span class="n">lookup</span><span class="p">,</span> <span class="n">unwind</span><span class="p">,</span> <span class="n">project</span><span class="p">]</span>
<span class="linenos"> 825</span>        <span class="k">if</span> <span class="nb">filter</span><span class="p">:</span>
<span class="linenos"> 826</span>            <span class="n">query</span> <span class="o">=</span> <span class="n">qops</span><span class="o">.</span><span class="n">MATCH</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_filter_criteria</span><span class="p">(</span><span class="o">**</span><span class="nb">filter</span><span class="p">))</span>
<span class="linenos"> 827</span>            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="linenos"> 828</span>        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
<span class="linenos"> 829</span>            <span class="n">sort_cols</span> <span class="o">=</span> <span class="n">make_list</span><span class="p">(</span><span class="n">on</span> <span class="ow">or</span> <span class="p">[</span><span class="n">left_on</span><span class="p">,</span> <span class="n">right_on</span><span class="p">])</span>
<span class="linenos"> 830</span>            <span class="n">sort_key</span> <span class="o">=</span> <span class="n">qops</span><span class="o">.</span><span class="n">make_sortkey</span><span class="p">(</span><span class="n">sort_cols</span><span class="p">)</span>
<span class="linenos"> 831</span>            <span class="n">sort</span> <span class="o">=</span> <span class="n">qops</span><span class="o">.</span><span class="n">SORT</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">sort_key</span><span class="p">))</span>
<span class="linenos"> 832</span>            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span>
<span class="linenos"> 833</span>        <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="linenos"> 834</span>        <span class="k">if</span> <span class="n">inspect</span><span class="p">:</span>
<span class="linenos"> 835</span>            <span class="n">result</span> <span class="o">=</span> <span class="n">pipeline</span>
<span class="linenos"> 836</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 837</span>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">allowDiskUse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 838</span>            <span class="n">result</span> <span class="o">=</span> <span class="n">MDataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="n">target_name</span><span class="p">],</span>
<span class="linenos"> 839</span>                                <span class="n">force_columns</span><span class="o">=</span><span class="n">expected_columns</span><span class="p">)</span>
<span class="linenos"> 840</span>        <span class="k">return</span> <span class="n">result</span></div>

<span class="linenos"> 841</span>
<span class="linenos"> 842</span>    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="linenos"> 843</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Collection</span><span class="p">):</span>
<span class="linenos"> 844</span>            <span class="n">other</span> <span class="o">=</span> <span class="n">MDataFrame</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
<span class="linenos"> 845</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
<span class="linenos"> 846</span>            <span class="n">other</span><span class="p">,</span> <span class="n">MDataFrame</span><span class="p">),</span> <span class="s2">&quot;both must be MDataFrames, got other=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
<span class="linenos"> 847</span>        <span class="n">outname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span>
<span class="linenos"> 848</span>        <span class="n">mrout</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 849</span>            <span class="s1">&#39;merge&#39;</span><span class="p">:</span> <span class="n">outname</span><span class="p">,</span>
<span class="linenos"> 850</span>            <span class="s1">&#39;nonAtomic&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 851</span>        <span class="p">}</span>
<span class="linenos"> 852</span>        <span class="n">mapfn</span> <span class="o">=</span> <span class="n">Code</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="linenos"> 853</span><span class="s2">        function() {</span>
<span class="linenos"> 854</span><span class="s2">           this._id = ObjectId();</span>
<span class="linenos"> 855</span><span class="s2">           if(this[&#39;_om#rowid&#39;]) {</span>
<span class="linenos"> 856</span><span class="s2">              this[&#39;_om#rowid&#39;] += </span><span class="si">%s</span><span class="s2">;</span>
<span class="linenos"> 857</span><span class="s2">           }</span>
<span class="linenos"> 858</span><span class="s2">           emit(this._id, this);</span>
<span class="linenos"> 859</span><span class="s2">        }</span>
<span class="linenos"> 860</span><span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
<span class="linenos"> 861</span>        <span class="n">reducefn</span> <span class="o">=</span> <span class="n">Code</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="linenos"> 862</span><span class="s2">        function(key, value) {</span>
<span class="linenos"> 863</span><span class="s2">           return value;</span>
<span class="linenos"> 864</span><span class="s2">        }</span>
<span class="linenos"> 865</span><span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 866</span>        <span class="n">finfn</span> <span class="o">=</span> <span class="n">Code</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="linenos"> 867</span><span class="s2">        function(key, value) {</span>
<span class="linenos"> 868</span><span class="s2">           return value;</span>
<span class="linenos"> 869</span><span class="s2">        }</span>
<span class="linenos"> 870</span><span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 871</span>        <span class="n">other</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">map_reduce</span><span class="p">(</span><span class="n">mapfn</span><span class="p">,</span> <span class="n">reducefn</span><span class="p">,</span> <span class="n">mrout</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="n">finfn</span><span class="p">,</span> <span class="n">jsMode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 872</span>        <span class="n">unwind</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 873</span>            <span class="s2">&quot;$replaceRoot&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos"> 874</span>                <span class="s2">&quot;newRoot&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos"> 875</span>                    <span class="s2">&quot;$ifNull&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;$value&quot;</span><span class="p">,</span> <span class="s2">&quot;$$CURRENT&quot;</span><span class="p">],</span>
<span class="linenos"> 876</span>                <span class="p">}</span>
<span class="linenos"> 877</span>            <span class="p">}</span>
<span class="linenos"> 878</span>        <span class="p">}</span>
<span class="linenos"> 879</span>        <span class="n">output</span> <span class="o">=</span> <span class="n">qops</span><span class="o">.</span><span class="n">OUT</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span>
<span class="linenos"> 880</span>        <span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span><span class="n">unwind</span><span class="p">,</span> <span class="n">output</span><span class="p">]</span>
<span class="linenos"> 881</span>        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">allowDiskUse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 882</span>        <span class="k">return</span> <span class="bp">self</span>
<span class="linenos"> 883</span>
<span class="linenos"> 884</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_collection_name_of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">some</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 885</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 886</span><span class="sd">        determine the collection name of the given parameter</span>
<span class="linenos"> 887</span>
<span class="linenos"> 888</span><span class="sd">        returns the collection name if some is a MDataFrame, a Collection</span>
<span class="linenos"> 889</span><span class="sd">        or a string_type. Otherwise returns default</span>
<span class="linenos"> 890</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 891</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">some</span><span class="p">,</span> <span class="n">MDataFrame</span><span class="p">):</span>
<span class="linenos"> 892</span>            <span class="n">name</span> <span class="o">=</span> <span class="n">some</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span>
<span class="linenos"> 893</span>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">some</span><span class="p">,</span> <span class="n">Collection</span><span class="p">):</span>
<span class="linenos"> 894</span>            <span class="n">name</span> <span class="o">=</span> <span class="n">some</span><span class="o">.</span><span class="n">name</span>
<span class="linenos"> 895</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 896</span>            <span class="n">name</span> <span class="o">=</span> <span class="n">default</span>
<span class="linenos"> 897</span>        <span class="k">return</span> <span class="n">name</span>
<span class="linenos"> 898</span>
<span class="linenos"> 899</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_filter_criteria</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos"> 900</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 901</span><span class="sd">        return mongo query from filter specs</span>
<span class="linenos"> 902</span>
<span class="linenos"> 903</span><span class="sd">        this uses a Filter to produce the query from the kwargs.</span>
<span class="linenos"> 904</span>
<span class="linenos"> 905</span><span class="sd">        :param args: a Q object or logical combination of Q objects</span>
<span class="linenos"> 906</span><span class="sd">           (optional)</span>
<span class="linenos"> 907</span><span class="sd">        :param kwargs: all AND filter criteria</span>
<span class="linenos"> 908</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 909</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 910</span>            <span class="n">q</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 911</span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">MongoQ</span><span class="p">):</span>
<span class="linenos"> 912</span>                <span class="n">filter_criteria</span> <span class="o">=</span> <span class="n">Filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">query</span>
<span class="linenos"> 913</span>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">Filter</span><span class="p">):</span>
<span class="linenos"> 914</span>                <span class="n">filter_criteria</span> <span class="o">=</span> <span class="n">Filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">query</span>
<span class="linenos"> 915</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 916</span>            <span class="n">filter_criteria</span> <span class="o">=</span> <span class="n">Filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">query</span>
<span class="linenos"> 917</span>        <span class="k">return</span> <span class="n">filter_criteria</span>
<span class="linenos"> 918</span>
<div class="viewcode-block" id="MDataFrame.query_inplace">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MDataFrame.query_inplace">[docs]</a>
<span class="linenos"> 919</span>    <span class="k">def</span><span class="w"> </span><span class="nf">query_inplace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos"> 920</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 921</span><span class="sd">        filters this MDataFrame and returns it.</span>
<span class="linenos"> 922</span>
<span class="linenos"> 923</span><span class="sd">        Any subsequent operation on the dataframe will have the filter</span>
<span class="linenos"> 924</span><span class="sd">        applied. To reset the filter call .reset() without arguments.</span>
<span class="linenos"> 925</span>
<span class="linenos"> 926</span><span class="sd">        :param args: a Q object or logical combination of Q objects</span>
<span class="linenos"> 927</span><span class="sd">           (optional)</span>
<span class="linenos"> 928</span><span class="sd">        :param kwargs: all AND filter criteria</span>
<span class="linenos"> 929</span><span class="sd">        :return: self</span>
<span class="linenos"> 930</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 931</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluated</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 932</span>        <span class="bp">self</span><span class="o">.</span><span class="n">filter_criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filter_criteria</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 933</span>        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">FilteredCollection</span><span class="p">(</span>
<span class="linenos"> 934</span>            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_criteria</span><span class="p">)</span>
<span class="linenos"> 935</span>        <span class="k">return</span> <span class="bp">self</span></div>

<span class="linenos"> 936</span>
<div class="viewcode-block" id="MDataFrame.query">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MDataFrame.query">[docs]</a>
<span class="linenos"> 937</span>    <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos"> 938</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 939</span><span class="sd">        return a new MDataFrame with a filter criteria</span>
<span class="linenos"> 940</span>
<span class="linenos"> 941</span><span class="sd">        Any subsequent operation on the new dataframe will have the filter</span>
<span class="linenos"> 942</span><span class="sd">        applied. To reset the filter call .reset() without arguments.</span>
<span class="linenos"> 943</span>
<span class="linenos"> 944</span><span class="sd">        Note: Unlike pandas DataFrames, a filtered MDataFrame operates</span>
<span class="linenos"> 945</span><span class="sd">        on the same collection as the original DataFrame</span>
<span class="linenos"> 946</span>
<span class="linenos"> 947</span><span class="sd">        :param args: a Q object or logical combination of Q objects</span>
<span class="linenos"> 948</span><span class="sd">           (optional)</span>
<span class="linenos"> 949</span><span class="sd">        :param kwargs: all AND filter criteria</span>
<span class="linenos"> 950</span><span class="sd">        :return: a new MDataFrame with the filter applied</span>
<span class="linenos"> 951</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 952</span>        <span class="n">effective_filter</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_criteria</span><span class="p">)</span>
<span class="linenos"> 953</span>        <span class="n">filter_criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filter_criteria</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 954</span>        <span class="k">if</span> <span class="s1">&#39;$and&#39;</span> <span class="ow">in</span> <span class="n">effective_filter</span><span class="p">:</span>
<span class="linenos"> 955</span>            <span class="n">effective_filter</span><span class="p">[</span><span class="s1">&#39;$and&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filter_criteria</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;$and&#39;</span><span class="p">))</span>
<span class="linenos"> 956</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 957</span>            <span class="n">effective_filter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">filter_criteria</span><span class="p">)</span>
<span class="linenos"> 958</span>        <span class="n">coll</span> <span class="o">=</span> <span class="n">FilteredCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">effective_filter</span><span class="p">)</span>
<span class="linenos"> 959</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">collection</span><span class="o">=</span><span class="n">coll</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">effective_filter</span><span class="p">)</span></div>

<span class="linenos"> 960</span>
<div class="viewcode-block" id="MDataFrame.create_index">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MDataFrame.create_index">[docs]</a>
<span class="linenos"> 961</span>    <span class="k">def</span><span class="w"> </span><span class="nf">create_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos"> 962</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 963</span><span class="sd">        create and index the easy way</span>
<span class="linenos"> 964</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 965</span>        <span class="n">keys</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">MongoQueryOps</span><span class="p">()</span><span class="o">.</span><span class="n">make_index</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
<span class="linenos"> 966</span>        <span class="n">result</span> <span class="o">=</span> <span class="n">ensure_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 967</span>        <span class="k">return</span> <span class="n">result</span></div>

<span class="linenos"> 968</span>
<span class="linenos"> 969</span>    <span class="k">def</span><span class="w"> </span><span class="nf">list_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 970</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 971</span><span class="sd">        list all indices in database</span>
<span class="linenos"> 972</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 973</span>        <span class="k">return</span> <span class="n">cursor_to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">list_indexes</span><span class="p">())</span>
<span class="linenos"> 974</span>
<span class="linenos"> 975</span>    <span class="k">def</span><span class="w"> </span><span class="nf">iterchunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="linenos"> 976</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 977</span><span class="sd">        return an iterator</span>
<span class="linenos"> 978</span>
<span class="linenos"> 979</span><span class="sd">        Args:</span>
<span class="linenos"> 980</span><span class="sd">            chunksize (int): number of rows in each chunk</span>
<span class="linenos"> 981</span>
<span class="linenos"> 982</span><span class="sd">        Returns:</span>
<span class="linenos"> 983</span><span class="sd">            a dataframe of max. length chunksize</span>
<span class="linenos"> 984</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 985</span>        <span class="n">chunksize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chunksize</span><span class="p">)</span>
<span class="linenos"> 986</span>        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 987</span>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos"> 988</span>            <span class="n">chunkdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">chunksize</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
<span class="linenos"> 989</span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunkdf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 990</span>                <span class="k">break</span>
<span class="linenos"> 991</span>            <span class="n">i</span> <span class="o">+=</span> <span class="n">chunksize</span>
<span class="linenos"> 992</span>            <span class="k">yield</span> <span class="n">chunkdf</span>
<span class="linenos"> 993</span>
<span class="linenos"> 994</span>    <span class="k">def</span><span class="w"> </span><span class="nf">itertuples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="linenos"> 995</span>        <span class="n">chunksize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chunksize</span><span class="p">)</span>
<span class="linenos"> 996</span>        <span class="vm">__doc__</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">itertuples</span><span class="o">.</span><span class="vm">__doc__</span>
<span class="linenos"> 997</span>
<span class="linenos"> 998</span>        <span class="k">for</span> <span class="n">chunkdf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterchunks</span><span class="p">(</span><span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">):</span>
<span class="linenos"> 999</span>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">chunkdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<span class="linenos">1000</span>                <span class="k">yield</span> <span class="n">row</span>
<span class="linenos">1001</span>
<span class="linenos">1002</span>    <span class="k">def</span><span class="w"> </span><span class="nf">iterrows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="linenos">1003</span>        <span class="n">chunksize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chunksize</span><span class="p">)</span>
<span class="linenos">1004</span>        <span class="vm">__doc__</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">iterrows</span><span class="o">.</span><span class="vm">__doc__</span>
<span class="linenos">1005</span>
<span class="linenos">1006</span>        <span class="k">for</span> <span class="n">chunkdf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterchunks</span><span class="p">(</span><span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">):</span>
<span class="linenos">1007</span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunkdf</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="linenos">1008</span>                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">chunkdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<span class="linenos">1009</span>                    <span class="k">yield</span> <span class="n">row</span>
<span class="linenos">1010</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1011</span>                <span class="c1"># Series does not have iterrows</span>
<span class="linenos">1012</span>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunkdf</span><span class="p">),</span> <span class="n">chunksize</span><span class="p">):</span>
<span class="linenos">1013</span>                    <span class="k">yield</span> <span class="n">chunkdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">chunksize</span><span class="p">]</span>
<span class="linenos">1014</span>
<span class="linenos">1015</span>    <span class="k">def</span><span class="w"> </span><span class="nf">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1016</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="s1">&#39;iteritems&#39;</span><span class="p">):</span>
<span class="linenos">1017</span>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;MDataFrame.iteritems has been removed since Pandas 2.0. Use .items instead.&#39;</span><span class="p">)</span>
<span class="linenos">1018</span>        <span class="vm">__doc__</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">iteritems</span><span class="o">.</span><span class="vm">__doc__</span>
<span class="linenos">1019</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="linenos">1020</span>
<span class="linenos">1021</span>    <span class="k">def</span><span class="w"> </span><span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1022</span>        <span class="vm">__doc__</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="vm">__doc__</span>
<span class="linenos">1023</span>
<span class="linenos">1024</span>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<span class="linenos">1025</span>            <span class="k">yield</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="linenos">1026</span>
<span class="linenos">1027</span>    <span class="nd">@property</span>
<span class="linenos">1028</span>    <span class="k">def</span><span class="w"> </span><span class="nf">loc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1029</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1030</span><span class="sd">        Access by index</span>
<span class="linenos">1031</span>
<span class="linenos">1032</span><span class="sd">        Use as mdf.loc[index_value]</span>
<span class="linenos">1033</span>
<span class="linenos">1034</span><span class="sd">        :return: MLocIndexer</span>
<span class="linenos">1035</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1036</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluated</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1037</span>        <span class="n">indexer</span> <span class="o">=</span> <span class="n">MLocIndexer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="linenos">1038</span>        <span class="k">return</span> <span class="n">indexer</span>
<span class="linenos">1039</span>
<span class="linenos">1040</span>    <span class="nd">@property</span>
<span class="linenos">1041</span>    <span class="k">def</span><span class="w"> </span><span class="nf">iloc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1042</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluated</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1043</span>        <span class="n">indexer</span> <span class="o">=</span> <span class="n">MPosIndexer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="linenos">1044</span>        <span class="k">return</span> <span class="n">indexer</span>
<span class="linenos">1045</span>
<span class="linenos">1046</span>    <span class="k">def</span><span class="w"> </span><span class="nf">rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="linenos">1047</span>        <span class="c1"># equivalent to .iloc[start:end].iteritems(),</span>
<span class="linenos">1048</span>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">chunksize</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">))</span>
<span class="linenos">1049</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)]</span><span class="o">.</span><span class="n">iterchunks</span><span class="p">(</span><span class="n">chunksize</span><span class="p">)</span>
<span class="linenos">1050</span>
<span class="linenos">1051</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1052</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getcopy_kwargs</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="linenos">1053</span>        <span class="k">return</span> <span class="s2">&quot;MDataFrame(collection=</span><span class="si">{collection.name}</span><span class="s2">, </span><span class="si">{kwargs}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
<span class="linenos">1054</span>                                                                           <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span></div>

<span class="linenos">1055</span>
<span class="linenos">1056</span>
<div class="viewcode-block" id="MSeries">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MSeries">[docs]</a>
<span class="linenos">1057</span><span class="k">class</span><span class="w"> </span><span class="nc">MSeries</span><span class="p">(</span><span class="n">MDataFrame</span><span class="p">):</span>
<span class="linenos">1058</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1059</span><span class="sd">    Series implementation for MDataFrames</span>
<span class="linenos">1060</span>
<span class="linenos">1061</span><span class="sd">    behaves like a DataFrame but limited to one column.</span>
<span class="linenos">1062</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">1063</span>
<span class="linenos">1064</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">1065</span>        <span class="nb">super</span><span class="p">(</span><span class="n">MSeries</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1066</span>        <span class="c1"># true if only unique values apply</span>
<span class="linenos">1067</span>        <span class="bp">self</span><span class="o">.</span><span class="n">is_unique</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1068</span>        <span class="c1"># apply mixins</span>
<span class="linenos">1069</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_applyto</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
<span class="linenos">1070</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_mixins</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1071</span>
<span class="linenos">1072</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols_or_slice</span><span class="p">):</span>
<span class="linenos">1073</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cols_or_slice</span><span class="p">,</span> <span class="n">Filter</span><span class="p">):</span>
<span class="linenos">1074</span>            <span class="k">return</span> <span class="n">MSeries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
<span class="linenos">1075</span>                           <span class="n">query</span><span class="o">=</span><span class="n">cols_or_slice</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
<span class="linenos">1076</span>        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MSeries</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">cols_or_slice</span><span class="p">)</span>
<span class="linenos">1077</span>
<span class="linenos">1078</span>    <span class="nd">@property</span>
<span class="linenos">1079</span>    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1080</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">1081</span>
<div class="viewcode-block" id="MSeries.unique">
<a class="viewcode-back" href="../../reference/public.html#omegaml.mdataframe.MSeries.unique">[docs]</a>
<span class="linenos">1082</span>    <span class="k">def</span><span class="w"> </span><span class="nf">unique</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1083</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1084</span><span class="sd">        return the unique set of values for the series</span>
<span class="linenos">1085</span>
<span class="linenos">1086</span><span class="sd">        :return: MSeries</span>
<span class="linenos">1087</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1088</span>        <span class="bp">self</span><span class="o">.</span><span class="n">is_unique</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1089</span>        <span class="k">return</span> <span class="bp">self</span></div>

<span class="linenos">1090</span>
<span class="linenos">1091</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1092</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
<span class="linenos">1093</span>            <span class="c1"># this way indexes get applied</span>
<span class="linenos">1094</span>            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">make_tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">1095</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1096</span>            <span class="n">cursor</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MSeries</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_get_cursor</span><span class="p">()</span>
<span class="linenos">1097</span>        <span class="k">return</span> <span class="n">cursor</span>
<span class="linenos">1098</span>
<span class="linenos">1099</span>    <span class="nd">@property</span>
<span class="linenos">1100</span>    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1101</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1102</span><span class="sd">        return the value of the series</span>
<span class="linenos">1103</span>
<span class="linenos">1104</span><span class="sd">        this is a Series unless unique() was called. If unique()</span>
<span class="linenos">1105</span><span class="sd">        only distinct values are returned as an array, matching</span>
<span class="linenos">1106</span><span class="sd">        the behavior of a Series</span>
<span class="linenos">1107</span>
<span class="linenos">1108</span><span class="sd">        :return: pandas.Series</span>
<span class="linenos">1109</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1110</span>        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cursor</span><span class="p">()</span>
<span class="linenos">1111</span>        <span class="n">column</span> <span class="o">=</span> <span class="n">make_tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">1112</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
<span class="linenos">1113</span>            <span class="c1"># the .distinct() cursor returns a list of values</span>
<span class="linenos">1114</span>            <span class="c1"># this is to make sure we return the same thing as pandas</span>
<span class="linenos">1115</span>            <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">]</span>
<span class="linenos">1116</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1117</span>            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataframe_from_cursor</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
<span class="linenos">1118</span>            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
<span class="linenos">1119</span>            <span class="n">val</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
<span class="linenos">1120</span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_loc_indexer</span><span class="p">:</span>
<span class="linenos">1121</span>                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">1122</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_inspect</span><span class="p">:</span>
<span class="linenos">1123</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_inspect_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">explain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="linenos">1124</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preparefn</span><span class="p">:</span>
<span class="linenos">1125</span>            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preparefn</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<span class="linenos">1126</span>        <span class="k">return</span> <span class="n">val</span>
<span class="linenos">1127</span>
<span class="linenos">1128</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1129</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getcopy_kwargs</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="linenos">1130</span>        <span class="k">return</span> <span class="s2">&quot;MSeries(collection=</span><span class="si">{collection.name}</span><span class="s2">, </span><span class="si">{kwargs}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span>
<span class="linenos">1131</span>                                                                        <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1132</span>
<span class="linenos">1133</span>    <span class="nd">@property</span>
<span class="linenos">1134</span>    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1135</span>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span></div>

<span class="linenos">1136</span>
<span class="linenos">1137</span>
<span class="linenos">1138</span><span class="k">def</span><span class="w"> </span><span class="nf">_mdf_remake</span><span class="p">(</span><span class="n">collection</span><span class="p">):</span>
<span class="linenos">1139</span>    <span class="c1"># recreate a pickled MDF</span>
<span class="linenos">1140</span>    <span class="n">mdf</span> <span class="o">=</span> <span class="n">MDataFrame</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
<span class="linenos">1141</span>    <span class="k">return</span> <span class="n">mdf</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025 (c) omegaml.io by one2seven GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>

      </div>
    </section>
  </div>
  <!-- version plugin for rtd template without sidebar -->
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: 0.13.7
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../../0.11.3/index.html" class="version-ref-0.11.3">0.11.3</a></dd>
      <dd><a href="../../../0.11.4/index.html" class="version-ref-0.11.4">0.11.4</a></dd>
      <dd><a href="../../../0.12.0/index.html" class="version-ref-0.12.0">0.12.0</a></dd>
      <dd><a href="../../../0.13.0/index.html" class="version-ref-0.13.0">0.13.0</a></dd>
      <dd><a href="../../../0.13.2/index.html" class="version-ref-0.13.2">0.13.2</a></dd>
      <dd><a href="../../../0.13.4/index.html" class="version-ref-0.13.4">0.13.4</a></dd>
      <dd><a href="../../../0.13.5/index.html" class="version-ref-0.13.5">0.13.5</a></dd>
      <dd><a href="../../../0.13.6/index.html" class="version-ref-0.13.6">0.13.6</a></dd>
      <dd><a href="mdataframe.html" class="version-ref-0.13.7">0.13.7</a></dd>
      <dd><a href="../../../0.14.0/index.html" class="version-ref-0.14.0">0.14.0</a></dd>
      <dd><a href="../../../0.15.1/index.html" class="version-ref-0.15.1">0.15.1</a></dd>
      <dd><a href="../../../0.15.2/index.html" class="version-ref-0.15.2">0.15.2</a></dd>
      <dd><a href="../../../latest/index.html" class="version-ref-latest">latest</a></dd>
      <dd><a href="../../../release/0.15.3/index.html" class="version-ref-release/0.15.3">0.15.3</a></dd>
      <dd><a href="../../../release/0.15.5/index.html" class="version-ref-release/0.15.5">0.15.5</a></dd>
      <dd><a href="../../../release/0.16.0/index.html" class="version-ref-release/0.16.0">0.16.0</a></dd>
      <dd><a href="../../../release/0.16.1/index.html" class="version-ref-release/0.16.1">0.16.1</a></dd>
      <dd><a href="../../../release/0.16.2/index.html" class="version-ref-release/0.16.2">0.16.2</a></dd>
      <dd><a href="../../../release/0.16.3/index.html" class="version-ref-release/0.16.3">0.16.3</a></dd>
      <dd><a href="../../../release/0.16.4/index.html" class="version-ref-release/0.16.4">0.16.4</a></dd>
      <dd><a href="../../../release/0.17.0/index.html" class="version-ref-release/0.17.0">0.17.0</a></dd>
      <dd><a href="../../../release/0.4/index.html" class="version-ref-release/0.4">0.4</a></dd>
      <dd><a href="../../../release/0.5/index.html" class="version-ref-release/0.5">0.5</a></dd>
      <dd><a href="../../../release/0.9/index.html" class="version-ref-release/0.9">0.9</a></dd>
      <dd><a href="../../../stable/index.html" class="version-ref-stable">stable</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../../master/index.html">master</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>