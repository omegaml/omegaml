version: '3'
services:
   nginx:
      image: nginx
      container_name: nginx
      ports:
      - 5000:5000
      - 5671:5671
      - 27017:27017
      - 8899:8888
      - 8010:8010
      links:
         - rabbitmq
         - mongodb
         - omegaml
         - omjobs
         - apphub
      volumes:
         - ./etc/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
         - ./etc/nginx/http.conf:/etc/nginx/conf.d/http.conf:ro
         - ./etc/nginx/stream.conf:/etc/nginx/conf.d/stream.conf:ro
   omegaml:
      image: omegaml/omegaml-ee:latest
      container_name: omegaml
      hostname: omegaml
      links:
         - rabbitmq
         - mongodb
         - mysql
      working_dir: /app
      command: scripts/startweb.sh
      volumes:
         - pythonlib:/app/pylib/user
      environment:
         - APP=omegaml
         - APP_CONFIG=EnvSettings_docker
         - MYSQL_DATABASE=omegaml
         - MYSQL_USER=omegaml
         - MYSQL_PASSWORD=mysql
         - OMEGA_BROKER=amqp://omegaml:ZQQycr43FQFe9fqWqh2KBmauAGT9XdUe@rabbitmq:5671/omegaml
         - BROKER_URL=amqp://omegaml:ZQQycr43FQFe9fqWqh2KBmauAGT9XdUe@rabbitmq:5671/omegaml
         - OMEGA_BROKERAPI_URL=http://admin:een53uGa8Lvc9mKsyMyXtzH5pAMfD3FP@rabbitmq:15672/rmq
         - MONGO_ADMIN_URL=mongodb://admin:jk3XVEpbpevN4BgtEbmcCpVM24gc7RVB@mongodb/admin
         - OMEGA_MONGO_URL=mongodb://admin:jk3XVEpbpevN4BgtEbmcCpVM24gc7RVB@mongodb/userdb
         - OMEGA_JYHUB_USER=jyadmin
         - OMEGA_JYHUB_APIKEY=b7b034f57d442e605ab91f88a8936149e968e12e
         - JYHUB_HOST=localhost:8899
         - MONGODB_SERVICE_HOST=mongodb
         - OMEGA_USESSL=True
         - CA_CERTS_PATH=/app/etc-dev/mongo/certs/ca_certificate.pem
         - CELERY_Q=default
         - PYTHONUSERBASE="/app/pylib/user"
   apphub:
      image: omegaml/apphub:0.3.2-dev13
      container_name: apphub
      hostname: apphub
      links:
         - mongodb
         - rabbitmq
         - omegaml
         - redis
      working_dir: /app
      command: scripts/startapphub.sh
      volumes:
         - pythonlib:/app/pylib/user
         - ./etc-dev/mongo/certs/ca_certificate.pem:/app/etc-dev/mongo/certs/ca_certificate.pem
      environment:
         - OMEGA_BROKER=amqp://omegaml:ZQQycr43FQFe9fqWqh2KBmauAGT9XdUe@rabbitmq:5671/omegaml
         - OMEGA_RESTAPI_URL=http://omegaml:5000/
         - CA_CERTS_PATH=/app/etc-dev/mongo/certs/ca_certificate.pem
         - CELERY_Q=default
         - APP_CONFIG=EnvSettings_omegacloud_compose
         - WEB_CONCURRENCY=4
         - SESSION_TYPE=redis
         - SESSION_REDIS=redis://:dei5oy1YMeeghae3@redis
         - APPHUB_REGISTRY=apphub.contrib.registry.omegareg.OmegaCloudRegistry
         - APPHUB_URL_PREFIX=/apps
         - PYTHONUSERBASE="/app/pylib/user"
   # apphub caching
   redis:
      image: redis
      hostname: redis
      command: redis-server --requirepass dei5oy1YMeeghae3
   omjobs:
      image: omegaml/omegaml-ee:latest
      container_name: omjobs
      hostname: omjobs
      links:
         - omegaml
         - mongodb
      working_dir: /app
      command: scripts/omegajobs.sh
      volumes:
         - pythonlib:/app/pylib/user
      environment:
         - APP=omjobs
         - OMEGA_RESTAPI_URL=http://omegaml:5000/
         - OMEGA_BROKER=amqp://omegaml:ZQQycr43FQFe9fqWqh2KBmauAGT9XdUe@rabbitmq:5671/omegaml
         - MONGO_ADMIN_URL=mongodb://admin:jk3XVEpbpevN4BgtEbmcCpVM24gc7RVB@mongodb/admin
         - OMEGA_MONGO_URL=mongodb://admin:jk3XVEpbpevN4BgtEbmcCpVM24gc7RVB@mongodb/userdb
         - OMEGA_JYHUB_USER=jyadmin
         - OMEGA_JYHUB_APIKEY=b7b034f57d442e605ab91f88a8936149e968e12e
         - OMEGA_JYHUB_TOKEN=PQZ4Sw2YNvNpdnwbLetbDDDF6NcRbazv2dCL
         - OMEGA_USESSL=True
         - CA_CERTS_PATH=/app/etc-dev/mongo/certs/ca_certificate.pem
         - PYTHONUSERBASE="/app/pylib/user"
   worker:
      image: omegaml/omegaml-ee:latest
      container_name: worker
      hostname: worker
      links:
         - rabbitmq
         - mongodb
         - omegaml
      working_dir: /app
      command: honcho start worker
      volumes:
         - pythonlib:/app/pylib/user
      environment:
         - OMEGA_BROKER=amqp://omegaml:ZQQycr43FQFe9fqWqh2KBmauAGT9XdUe@rabbitmq:5671/omegaml
         - MONGO_ADMIN_URL=mongodb://admin:jk3XVEpbpevN4BgtEbmcCpVM24gc7RVB@mongodb/admin
         - OMEGA_MONGO_URL=mongodb://admin:jk3XVEpbpevN4BgtEbmcCpVM24gc7RVB@mongodb/userdb
         - OMEGA_RESTAPI_URL=http://omegaml:5000/
         - C_FORCE_ROOT=yes
         - OMEGA_USESSL=True
         - CA_CERTS_PATH=/app/etc-dev/mongo/certs/ca_certificate.pem
         - CELERY_Q=default
         - PYTHONUSERBASE="/app/pylib/user"
   omegaops:
      image: omegaml/omegaml-ee:latest
      container_name: omegaops
      hostname: worker
      links:
         - rabbitmq
         - mongodb
         - omegaml
      working_dir: /app
      command: honcho start scheduler omegaops
      volumes:
         - pythonlib:/app/pylib/user
      environment:
         - OMEGA_USERID=omops
         - OMEGA_APIKEY=686ae4620522e790d92009be674e3bdc0391164f
         - OMEGA_BROKER=amqp://omegaml:ZQQycr43FQFe9fqWqh2KBmauAGT9XdUe@rabbitmq:5671/omegaml
         - MONGO_ADMIN_URL=mongodb://admin:jk3XVEpbpevN4BgtEbmcCpVM24gc7RVB@mongodb/admin
         - OMEGA_MONGO_URL=mongodb://admin:jk3XVEpbpevN4BgtEbmcCpVM24gc7RVB@mongodb/userdb
         - OMEGA_RESTAPI_URL=http://omegaml:5000/
         - C_FORCE_ROOT=yes
         - MYSQL_DATABASE=omegaml
         - MYSQL_USER=omegaml
         - MYSQL_PASSWORD=mysql
         - OMEGA_USESSL=True
         - CA_CERTS_PATH=/app/etc-dev/mongo/certs/ca_certificate.pem
         - PYTHONUSERBASE="/app/pylib/user"
   rabbitmq:
      image: rabbitmq
      container_name: rabbitmq
      hostname: rabbitmq
      volumes:
         - ./etc-dev/rabbitmq/definitions.json:/etc/rabbitmq/definitions.json
         - ./etc-dev/rabbitmq/enabled_plugins:/etc/rabbitmq/enabled_plugins
         - ./etc-dev/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
         - ./etc-dev/rabbitmq/certs:/etc/rabbitmq/certs
      ports:
         - "15672:15672"
   mongodb:
      # initialize by running cat scripts/mongoinit.js | docker exec -i mongodb_1 mongo
      image: mongo:3.6.8-stretch
      container_name: mongodb
      hostname: mongodb
      volumes:
         - ./etc-dev/mongo/certs/server_key.pem:/etc/mongo/server_key.pem
      command:
         - "--auth"
         - "--sslMode"
         - "preferSSL"
         - "--sslPEMKeyFile"
         - "etc/mongo/server_key.pem"
         - "--oplogSize"
         - "100"
   mysql:
      image: mysql:5.7
      container_name: mysql
      environment:
         - MYSQL_ROOT_PASSWORD=rootadmin
         - MYSQL_DATABASE=omegaml
         - MYSQL_USER=omegaml
         - MYSQL_PASSWORD=mysql

volumes:
   pythonlib:
