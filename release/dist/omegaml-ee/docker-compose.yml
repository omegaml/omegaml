version: '3'
services:
   nginx:
      image: nginx
      container_name: nginx
      ports:
      - 5000:5000
      - 5671:5671
      - 27017:27017
      - 8899:8888
      - 8010:8010
      links:
         - rabbitmq
         - mongodb
         - omegaml
         - omjobs
         - apphub
      volumes:
         - ./etc/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
         - ./etc/nginx/http.conf:/etc/nginx/conf.d/http.conf:ro
         - ./etc/nginx/stream.conf:/etc/nginx/conf.d/stream.conf:ro
   omegaml:
      image: omegaml/omegaml-ee:latest
      container_name: omegaml
      hostname: omegaml
      links:
         - rabbitmq
         - mongodb
         - postgres
      working_dir: /app
      command: scripts/startweb.sh
      volumes:
         - pythonlib:/app/pylib/user
      environment:
         - APP=omegaml
         - APP_CONFIG=EnvSettings_docker
         - DATABASE_URL=postgres://omegaml:pgadmin@postgres:5432/omegaml
         - OMEGA_BROKER=amqp://omegaml:ZQQycr43FQFe9fqWqh2KBmauAGT9XdUe@rabbitmq:5671/omegaml
         - BROKER_URL=amqp://omegaml:ZQQycr43FQFe9fqWqh2KBmauAGT9XdUe@rabbitmq:5671/omegaml
         - OMEGA_BROKERAPI_URL=http://admin:een53uGa8Lvc9mKsyMyXtzH5pAMfD3FP@rabbitmq:15672/rmq
         - MONGO_ADMIN_URL=mongodb://admin:jk3XVEpbpevN4BgtEbmcCpVM24gc7RVB@mongodb/admin
         - OMEGA_MONGO_URL=mongodb://admin:jk3XVEpbpevN4BgtEbmcCpVM24gc7RVB@mongodb/userdb
         - OMEGA_JYHUB_USER=jyadmin
         - OMEGA_JYHUB_APIKEY=b7b034f57d442e605ab91f88a8936149e968e12e
         - JYHUB_HOST=localhost:8899
         - OMEGA_USESSL=True
         - CA_CERTS_PATH=/app/etc-dev/mongo/certs/ca_certificate.pem
         - CELERY_Q=default
         - PYTHONUSERBASE="/app/pylib/user"
         - OMEGA_SERVICES_INCLUSTER=yes
         - MONGO_HOST=localhost:27017
         - MONGO_SERVICE_HOST=mongodb:27017
   apphub:
      image: omegaml/apphub:0.5.0-rc4
      container_name: apphub
      hostname: apphub
      links:
         - mongodb
         - rabbitmq
         - omegaml
         - redis
      working_dir: /app
      command: scripts/startapphub.sh
      volumes:
         - pythonlib:/app/pylib/user
         - ./etc-dev/mongo/certs/ca_certificate.pem:/app/etc-dev/mongo/certs/ca_certificate.pem
      environment:
         - OMEGA_BROKER=amqp://omegaml:ZQQycr43FQFe9fqWqh2KBmauAGT9XdUe@rabbitmq:5671/omegaml
         - OMEGA_RESTAPI_URL=http://omegaml:5000
         - CA_CERTS_PATH=/app/etc-dev/mongo/certs/ca_certificate.pem
         - CELERY_Q=default
         - APP_CONFIG=EnvSettings_omegacloud_compose
         - WEB_CONCURRENCY=4
         - SESSION_TYPE=redis
         - SESSION_REDIS=redis://:dei5oy1YMeeghae3@redis
         - APPHUB_REGISTRY=apphub.contrib.registry.omegareg.OmegaCloudRegistry
         - APPHUB_URL_PREFIX=/apps
         - PYTHONUSERBASE="/app/pylib/user"
         - OMEGA_SERVICES_INCLUSTER=yes
   # apphub caching
   redis:
      image: redis
      hostname: redis
      command: redis-server --requirepass dei5oy1YMeeghae3
   omjobs:
      image: omegaml/omegaml-ee:latest
      container_name: omjobs
      hostname: omjobs
      links:
         - omegaml
         - mongodb
      working_dir: /app
      command: scripts/omegajobs.sh
      volumes:
         - pythonlib:/app/pylib/user
      environment:
         - APP=omjobs
         - APP_CONFIG=EnvSettings_docker
         - OMEGA_RESTAPI_URL=http://omegaml:5000
         - OMEGA_JYHUB_USER=jyadmin
         - OMEGA_JYHUB_APIKEY=b7b034f57d442e605ab91f88a8936149e968e12e
         - OMEGA_JYHUB_TOKEN=PQZ4Sw2YNvNpdnwbLetbDDDF6NcRbazv2dCL
         - OMEGA_USESSL=True
         - CA_CERTS_PATH=/app/etc-dev/mongo/certs/ca_certificate.pem
         - PYTHONUSERBASE="/app/pylib/user"
         - OMEGA_SERVICES_INCLUSTER=yes
   worker:
      image: omegaml/omegaml-ee:latest
      container_name: worker
      hostname: worker
      links:
         - rabbitmq
         - mongodb
         - omegaml
      working_dir: /app
      command: honcho start worker
      volumes:
         - pythonlib:/app/pylib/user
      environment:
         - APP_CONFIG=EnvSettings_docker
         - OMEGA_BROKER=amqp://omegaml:ZQQycr43FQFe9fqWqh2KBmauAGT9XdUe@rabbitmq:5671/omegaml
         - MONGO_ADMIN_URL=mongodb://admin:jk3XVEpbpevN4BgtEbmcCpVM24gc7RVB@mongodb/admin
         - OMEGA_MONGO_URL=mongodb://admin:jk3XVEpbpevN4BgtEbmcCpVM24gc7RVB@mongodb/userdb
         - OMEGA_RESTAPI_URL=http://omegaml:5000
         - C_FORCE_ROOT=yes
         - OMEGA_USESSL=True
         - CA_CERTS_PATH=/app/etc-dev/mongo/certs/ca_certificate.pem
         - CELERY_Q=default
         - PYTHONUSERBASE="/app/pylib/user"
         - OMEGA_SERVICES_INCLUSTER=yes
   omegaops:
      image: omegaml/omegaml-ee:latest
      container_name: omegaops
      hostname: worker
      links:
         - rabbitmq
         - mongodb
         - omegaml
      working_dir: /app
      command: honcho start scheduler omegaops
      volumes:
         - pythonlib:/app/pylib/user
      environment:
         - APP_CONFIG=EnvSettings_docker
         - OMEGA_USERID=omops
         - OMEGA_APIKEY=686ae4620522e790d92009be674e3bdc0391164f
         - OMEGA_BROKER=amqp://omegaml:ZQQycr43FQFe9fqWqh2KBmauAGT9XdUe@rabbitmq:5671/omegaml
         - MONGO_ADMIN_URL=mongodb://admin:jk3XVEpbpevN4BgtEbmcCpVM24gc7RVB@mongodb/admin
         - OMEGA_MONGO_URL=mongodb://admin:jk3XVEpbpevN4BgtEbmcCpVM24gc7RVB@mongodb/userdb
         - OMEGA_RESTAPI_URL=http://omegaml:5000
         - C_FORCE_ROOT=yes
         - DATABASE_URL=postgres://omegaml:pgadmin@postgres:5432/omegaml
         - OMEGA_USESSL=True
         - CA_CERTS_PATH=/app/etc-dev/mongo/certs/ca_certificate.pem
         - PYTHONUSERBASE="/app/pylib/user"
         - OMEGA_SERVICES_INCLUSTER=yes
   rabbitmq:
      image: rabbitmq
      container_name: rabbitmq
      hostname: rabbitmq
      volumes:
         - ./etc-dev/rabbitmq/definitions.json:/etc/rabbitmq/definitions.json
         - ./etc-dev/rabbitmq/enabled_plugins:/etc/rabbitmq/enabled_plugins
         - ./etc-dev/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
         - ./etc-dev/rabbitmq/certs:/etc/rabbitmq/certs
      ports:
         - "15672:15672"
   mongodb:
      # initialize by running cat scripts/mongoinit.js | docker exec -i mongodb_1 mongo
      image: mongo:4.4.13-focal
      container_name: mongodb
      hostname: mongodb
      volumes:
         - ./etc-dev/mongo/certs/server_key.pem:/etc/mongo/server_key.pem
      command:
         - "--auth"
         - "--sslMode"
         - "preferSSL"
         - "--sslPEMKeyFile"
         - "etc/mongo/server_key.pem"
         - "--oplogSize"
         - "100"
   postgres:
      image: postgres:14.2
      container_name: postgres
      environment:
         - POSTGRES_PASSWORD=pgadmin
         - POSTGRES_USER=omegaml
         - POSTGRES_DB=omegaml

volumes:
   pythonlib:
